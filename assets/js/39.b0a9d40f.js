(window.webpackJsonp=window.webpackJsonp||[]).push([[39],{383:function(e,v,_){e.exports=_.p+"assets/img/dev-env.41efb4c3.png"},691:function(e,v,_){"use strict";_.r(v);var t=_(44),r=Object(t.a)({},(function(){var e=this,v=e.$createElement,t=e._self._c||v;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"当我有一台服务器时我做了什么"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#当我有一台服务器时我做了什么"}},[e._v("#")]),e._v(" 当我有一台服务器时我做了什么")]),e._v(" "),t("p",[e._v("当一八年末的时候，我写了一篇文章 "),t("a",{attrs:{href:"https://github.com/ChinaArJun/op-note/blob/master/when-server.md",target:"_blank",rel:"noopener noreferrer"}},[e._v("当我有一台服务器时我做了什么"),t("OutboundLink")],1)]),e._v(" "),t("p",[e._v("又是年末，我服务器的架构也发生了一些变化，因此总结一番")]),e._v(" "),t("ul",[t("li",[e._v("原文地址: "),t("a",{attrs:{href:"https://github.com/ChinaArJun/op-note/blob/master/when-server-2019.md",target:"_blank",rel:"noopener noreferrer"}},[e._v("当我有一台服务器时我做了什么"),t("OutboundLink")],1)]),e._v(" "),t("li",[e._v("系列文章: "),t("a",{attrs:{href:"https://github.com/ChinaArJun/op-note",target:"_blank",rel:"noopener noreferrer"}},[e._v("当我有一台服务器时我做了什么"),t("OutboundLink")],1)])]),e._v(" "),t("h2",{attrs:{id:"概览"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#概览"}},[e._v("#")]),e._v(" 概览")]),e._v(" "),t("p",[e._v("去年服务器有两台，一台 2C4G，一台 1C2G")]),e._v(" "),t("p",[e._v("今年服务器有三台，以以下名称作为 "),t("code",[e._v("hostname")]),e._v("，配置如下")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("dev")]),e._v(": 1C2G，不到一百块钱。用以日常编码，简单的反向代理以及项目部署")]),e._v(" "),t("li",[t("code",[e._v("shanyue")]),e._v(": 2C4G，k8s master node")]),e._v(" "),t("li",[t("code",[e._v("shuifeng")]),e._v(": 4C16G，k8s work node")])]),e._v(" "),t("p",[e._v("由于 "),t("code",[e._v("dev")]),e._v(" 的机器与去年列举出来的事情相似，这里只介绍下在这台1C2G的服务器上做了什么")]),e._v(" "),t("p",[e._v("简单画了这台服务器的架构图（不太会画，所以建了一个仓库 "),t("a",{attrs:{href:"https://github.com/ChinaArJun/graph",target:"_blank",rel:"noopener noreferrer"}},[e._v("ChinaArJun/graph"),t("OutboundLink")],1),e._v(" 用以学习各种架构图画法）")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://raw.githubusercontent.com/ChinaArJun/graph/master/draw/docker-compose.jpg",alt:""}})]),e._v(" "),t("h2",{attrs:{id:"博客与编码"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#博客与编码"}},[e._v("#")]),e._v(" 博客与编码")]),e._v(" "),t("p",[e._v("基本上自己的博客以及个人编码都在这台测试服务器上完成，至于为什么要在服务器下开发：")]),e._v(" "),t("ol",[t("li",[e._v("在公司 Mac 及我自己的笔记本间同步博客实在太痛苦了，而使用服务器作为中介则方便很多")])]),e._v(" "),t("p",[e._v("由于在服务器下写博客以及一些个人的代码，因此我新买的 MBP 也变成了一个显示器")]),e._v(" "),t("h3",{attrs:{id:"开发环境"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#开发环境"}},[e._v("#")]),e._v(" 开发环境")]),e._v(" "),t("p",[t("code",[e._v("zsh")]),e._v(" + "),t("code",[e._v("tmux")]),e._v(" + "),t("code",[e._v("vim")]),e._v("，截图如下")]),e._v(" "),t("p",[t("img",{attrs:{src:_(383),alt:""}})]),e._v(" "),t("p",[e._v("大部分时间都在这个模式下，如果写博客过程中需要截图，则先下载到随便一个目录，然后使用 "),t("code",[e._v("rsync")]),e._v(" 复制到目标路径")]),e._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("rsync")]),e._v(" ~/Documents/tmux.png dev:/path/Documents/blog/op/assets/dev-env.png\n")])])]),t("p",[t("code",[e._v("vscode remote")])]),e._v(" "),t("p",[e._v("如果需要调试代码，或者在写 "),t("code",[e._v("typescript")]),e._v("，则使用 "),t("code",[e._v("vscode remote")]),e._v(" 来完成工作")]),e._v(" "),t("p",[e._v("在 vscode 插件中关键字搜索，安装下载最多的三个插件就是了")]),e._v(" "),t("h3",{attrs:{id:"开发调试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#开发调试"}},[e._v("#")]),e._v(" 开发调试")]),e._v(" "),t("p",[e._v("如果调试前端页面需要在浏览器中打开地址，比如 "),t("code",[e._v("IP:8000")]),e._v("，一般采用两种方案")]),e._v(" "),t("ol",[t("li",[t("code",[e._v("nginx")]),e._v("镜像 + "),t("code",[e._v("volume")]),e._v("挂载 + "),t("code",[e._v("docker-compose")]),e._v(" + "),t("code",[e._v("traefik")]),e._v("服务发现。略微麻烦")]),e._v(" "),t("li",[t("code",[e._v("npm run dev")]),e._v(" + "),t("code",[e._v("openvpn")]),e._v("。在本地环境中的浏览器通过 "),t("code",[e._v("openvpn")]),e._v(" 连接局域网")])]),e._v(" "),t("p",[e._v("如果调试后端接口，需要打断点直接使用 "),t("code",[e._v("vscode remote")])]),e._v(" "),t("h2",{attrs:{id:"对外服务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#对外服务"}},[e._v("#")]),e._v(" 对外服务")]),e._v(" "),t("p",[e._v("有几个在公网下可访问的服务，如")]),e._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://github.com/ChinaArJun/wechat",target:"_blank",rel:"noopener noreferrer"}},[e._v("公众号开发"),t("OutboundLink")],1),e._v(": 主要用以给我的公众号导流 -> 如果想知道流程是什么，请转到这篇文章 "),t("a",{attrs:{href:"https://q.blog.zhequtao.com/interviews/2018.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("两年前端头条面试记"),t("OutboundLink")],1),e._v("，从中的隐藏部分你便能知道大概。过几天，我将写一篇文章作为总结。")]),e._v(" "),t("li",[t("a",{attrs:{href:"https://whoami.blog.zhequtao.com/",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://whoami.blog.zhequtao.com/"),t("OutboundLink")],1),e._v(": 用以测试 "),t("code",[e._v("traefik")]),e._v(" 的负载均衡及服务发现")]),e._v(" "),t("li",[e._v("若干 "),t("code",[e._v("reveal.js")]),e._v(" 页面")])]),e._v(" "),t("h2",{attrs:{id:"对内服务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#对内服务"}},[e._v("#")]),e._v(" 对内服务")]),e._v(" "),t("p",[e._v("主要以数据库为主，使用 "),t("code",[e._v("local DNS")]),e._v(" + "),t("code",[e._v("traefik")]),e._v(" + "),t("code",[e._v("openvpn")]),e._v(" 暴露在本地环境，使用禁掉公网端口以及仅在内网访问的IP白名单保证安全")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("postgres")]),e._v("，主要是一个关于诗词的数据库")]),e._v(" "),t("li",[t("code",[e._v("redis")])]),e._v(" "),t("li",[t("code",[e._v("traefik dashboard")]),e._v("，管理流量")])]),e._v(" "),t("p",[e._v("另外，这些对内对外的服务均是通过 "),t("code",[e._v("docker")]),e._v(" 以及 "),t("code",[e._v("docker-compose")]),e._v(" 部署")]),e._v(" "),t("h2",{attrs:{id:"博客去了哪里？"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#博客去了哪里？"}},[e._v("#")]),e._v(" 博客去了哪里？")]),e._v(" "),t("p",[e._v("以下是我博客的历程")]),e._v(" "),t("ol",[t("li",[e._v("个人服务器，后来服务器部署了 "),t("code",[e._v("k8s")]),e._v(" 就把博客挪出了")]),e._v(" "),t("li",[t("code",[e._v("netlify")]),e._v("，但是网络不好")]),e._v(" "),t("li",[t("code",[e._v("alioss")]),e._v(" + "),t("code",[e._v("github actions")]),e._v("，速度挺好，但是对 "),t("code",[e._v("http rewrite")]),e._v(" 支持的不是很好")])]),e._v(" "),t("p",[e._v("以后将会考虑 "),t("code",[e._v("serverless")])]),e._v(" "),t("p",[e._v("你可以发现，我现在更多的转向了一些免费的云服务，如")]),e._v(" "),t("ol",[t("li",[t("code",[e._v("serverless")]),e._v(" 可以写后端服务，我将把我的公众号的服务迁移过来。国内可用阿里云以及腾讯云，国外 aws")]),e._v(" "),t("li",[t("code",[e._v("dynomodb")]),e._v(" 与 "),t("code",[e._v("tablestore")]),e._v(" 免费的数据存储")]),e._v(" "),t("li",[t("code",[e._v("oss")]),e._v(" 很便宜的对象存储服务")]),e._v(" "),t("li",[t("code",[e._v("netlify")]),e._v(" 免费的静态网站托管托管服务")]),e._v(" "),t("li",[t("code",[e._v("github actions")]),e._v(" 免费的CICD及构建服务器")]),e._v(" "),t("li",[t("code",[e._v("sentry")]),e._v(" 免费的错误日志收集系统")]),e._v(" "),t("li",[t("code",[e._v("github")]),e._v(" 免费的私有仓库服务")]),e._v(" "),t("li",[t("code",[e._v("prerender.io")]),e._v(" 免费的预渲染服务")])]),e._v(" "),t("p",[e._v("嗯，有了这些都可以做一个自由开发者了 (自惭形秽中...)")]),e._v(" "),t("h2",{attrs:{id:"openvpn"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#openvpn"}},[e._v("#")]),e._v(" openVPN")]),e._v(" "),t("p",[e._v("数据库放在公网访问有点危险，用docker建了vpn在本地开发访问。使用了以下镜像")]),e._v(" "),t("p",[t("a",{attrs:{href:"https://github.com/kylemanna/docker-openvpn",target:"_blank",rel:"noopener noreferrer"}},[e._v("docker-openvpn"),t("OutboundLink")],1)]),e._v(" "),t("h2",{attrs:{id:"traefik"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#traefik"}},[e._v("#")]),e._v(" traefik")]),e._v(" "),t("p",[e._v("前后端需要做一个反向代理，选择了 traefik，更方便的服务配置以及服务发现，只需要配置容器的 "),t("code",[e._v("labels")]),e._v(" 就可以部署成功")]),e._v(" "),t("p",[e._v("另外 "),t("code",[e._v("traefik")]),e._v(" 可以很方便的自动生成 ssl/tls 证书，为你提供 https 服务")]),e._v(" "),t("h2",{attrs:{id:"dns-server"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#dns-server"}},[e._v("#")]),e._v(" DNS server")]),e._v(" "),t("p",[e._v("有了这么多的服务，但有的东西不好放在公网，如 "),t("code",[e._v("redis")]),e._v("，"),t("code",[e._v("postgres")]),e._v(" 一些私有服务以及开发待调试的服务，又记不住端口号，所以又搭了一个 "),t("code",[e._v("dns server")]),e._v("，方便在本地访问")]),e._v(" "),t("h2",{attrs:{id:"自动化运维"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#自动化运维"}},[e._v("#")]),e._v(" 自动化运维")]),e._v(" "),t("p",[e._v("初期折腾服务器的时候经常需要重装系统，并且我有三台服务器，自动化运维是必不可少的了。")]),e._v(" "),t("p",[e._v("必备工具如 "),t("code",[e._v("docker")]),e._v("，"),t("code",[e._v("git")]),e._v("，"),t("code",[e._v("vim")]),e._v("，"),t("code",[e._v("tmux")]),e._v("，"),t("code",[e._v("jq")]),e._v(" 都是通过 "),t("code",[e._v("ansible")]),e._v(" 进行的安装")]),e._v(" "),t("p",[e._v("可以参考我的配置")]),e._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://github.com/ChinaArJun/ansible-op",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://github.com/ChinaArJun/ansible-op"),t("OutboundLink")],1)])]),e._v(" "),t("p",[e._v("当你有了一台新服务器时，你可以遵循以下步骤")]),e._v(" "),t("ol",[t("li",[e._v("使用 ansible-role 预配置环境")]),e._v(" "),t("li",[e._v("如果没有 ansible-role，则自己写 role")]),e._v(" "),t("li",[e._v("对于一些服务使用 docker 进行安装")]),e._v(" "),t("li",[e._v("如果以上都无法解决，手动安装")])]),e._v(" "),t("h2",{attrs:{id:"监控"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#监控"}},[e._v("#")]),e._v(" 监控")]),e._v(" "),t("p",[e._v("没有像去年那样使用 "),t("code",[e._v("prometheus")]),e._v(" 一套，只简单了使用了两个命令以及阿里云自带的监控")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("ctop")]),e._v(": 监控容器")]),e._v(" "),t("li",[t("code",[e._v("htop")]),e._v(": 监控进程")])]),e._v(" "),t("h2",{attrs:{id:"对比"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#对比"}},[e._v("#")]),e._v(" 对比")]),e._v(" "),t("p",[e._v("如果说与去年有对比的话，体现在两方面")]),e._v(" "),t("ol",[t("li",[e._v("更彻底的容器化")]),e._v(" "),t("li",[e._v("更加拥抱云服务，如 "),t("code",[e._v("github actions")]),e._v("，serverless，netlify 等")])]),e._v(" "),t("p",[e._v("另外，还有一方面是自建了 k8s 集群 (真是烧钱)，将会在另一个仓库中介绍它的体系。但是如果你对 k8s 没有什么兴趣的话，"),t("strong",[e._v("这一台1C2G的服务器完全满足你的要求")])])])}),[],!1,null,null,null);v.default=r.exports}}]);