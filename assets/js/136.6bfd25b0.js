(window.webpackJsonp=window.webpackJsonp||[]).push([[136],{688:function(t,a,s){"use strict";s.r(a);var e=s(44),n=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"traefik-简易入门"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#traefik-简易入门"}},[t._v("#")]),t._v(" Traefik 简易入门")]),t._v(" "),s("p",[s("code",[t._v("traefik")]),t._v(" 与 "),s("code",[t._v("nginx")]),t._v(" 一样，是一款优秀的反向代理工具，或者叫 "),s("code",[t._v("Edge Router")]),t._v("。至于使用它的原因则基于以下几点")]),t._v(" "),s("ul",[s("li",[t._v("无须重启即可更新配置")]),t._v(" "),s("li",[t._v("自动的服务发现与负载均衡")]),t._v(" "),s("li",[t._v("与 "),s("code",[t._v("docker")]),t._v(" 的完美集成，基于 "),s("code",[t._v("container label")]),t._v(" 的配置")]),t._v(" "),s("li",[t._v("漂亮的 "),s("code",[t._v("dashboard")]),t._v(" 界面")]),t._v(" "),s("li",[s("code",[t._v("metrics")]),t._v(" 的支持，对 "),s("code",[t._v("prometheus")]),t._v(" 和 "),s("code",[t._v("k8s")]),t._v(" 的集成")])]),t._v(" "),s("p",[t._v("接下来讲一下它的安装，基本功能以及配置。"),s("code",[t._v("traefik")]),t._v(" 在 "),s("code",[t._v("v1")]),t._v(" 与 "),s("code",[t._v("v2")]),t._v(" 版本间差异过大，本篇文章采用了 "),s("code",[t._v("v2")])]),t._v(" "),s("ul",[s("li",[t._v("原文链接: "),s("a",{attrs:{href:"https://github.com/ChinaArJun/op-note/blob/master/traefik.md",target:"_blank",rel:"noopener noreferrer"}},[t._v("Traefik: 更好用更简单的反向代理"),s("OutboundLink")],1)]),t._v(" "),s("li",[t._v("系列文章: "),s("a",{attrs:{href:"https://github.com/ChinaArJun/op-note",target:"_blank",rel:"noopener noreferrer"}},[t._v("个人服务器运维指南"),s("OutboundLink")],1)])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://docs.traefik.io/assets/img/quickstart-diagram.png",alt:"traefik quickstart"}})]),t._v(" "),s("h2",{attrs:{id:"快速开始"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#快速开始"}},[t._v("#")]),t._v(" 快速开始")]),t._v(" "),s("p",[t._v("我们使用 "),s("code",[t._v("traefik:v2.0")]),t._v(" 作为镜像启动 "),s("code",[t._v("traefik")]),t._v(" 服务。"),s("code",[t._v("docker-compose.yaml")]),t._v(" 配置文件如下")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3'")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("traefik")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" traefik"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("v2.0\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("command")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("api.insecure=true "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("providers.docker\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"80:80"')]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"8080:8080"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /var/run/docker.sock"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/var/run/docker.sock\n")])])]),s("p",[t._v("此时我们使用命令 "),s("code",[t._v("docker-compose up -d")]),t._v(" 开启 "),s("code",[t._v("traefik")]),t._v(" 服务")]),t._v(" "),s("p",[t._v("接下来我们使用 "),s("code",[t._v("docker-compose")]),t._v(" 启动一个简单的 "),s("code",[t._v("http")]),t._v(" 服务，"),s("code",[t._v("docker-compose.yaml")]),t._v(" 配置文件如下")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3'")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 改镜像会暴露出自身的 `header` 信息")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("whoami")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" containous/whoami\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 设置Host 为 whoami.docker.localhost 进行域名访问")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"traefik.http.routers.whoami.rule=Host(`whoami.docker.localhost`)"')]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 使用已存在的 traefik 的 network")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("networks")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("default")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("external")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" traefik_default\n")])])]),s("p",[t._v("那 "),s("code",[t._v("whoami")]),t._v(" 这个 "),s("code",[t._v("http")]),t._v(" 服务做了什么事情呢")]),t._v(" "),s("ol",[s("li",[t._v("暴露了一个 "),s("code",[t._v("http")]),t._v(" 服务，主要提供一些 "),s("code",[t._v("header")]),t._v(" 以及 "),s("code",[t._v("ip")]),t._v(" 信息")]),t._v(" "),s("li",[t._v("配置了容器的 "),s("code",[t._v("labels")]),t._v("，设置该服务的 "),s("code",[t._v("Host")]),t._v(" 为 "),s("code",[t._v("whoami.docker.localhost")]),t._v("，给 "),s("code",[t._v("traefik")]),t._v(" 提供标记")])]),t._v(" "),s("p",[t._v("此时我们可以通过主机名 "),s("code",[t._v("whoami.docker.localhost")]),t._v(" 来访问 "),s("code",[t._v("whoami")]),t._v(" 服务，我们使用 "),s("code",[t._v("curl")]),t._v(" 做测试")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -H Host:whoami.docker.localhost http://127.0.0.1\nHostname: bc3e8f1a5066\nIP: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),t._v(".0.1\nIP: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("172.21")]),t._v(".0.2\nRemoteAddr: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("172.21")]),t._v(".0.1:37852\nGET / HTTP/1.1\nHost: whoami.docker.localhost\nUser-Agent: curl/7.29.0\nAccept: */*\nAccept-Encoding: "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("gzip")]),t._v("\nX-Forwarded-For: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),t._v(".0.1\nX-Forwarded-Host: whoami.docker.localhost\nX-Forwarded-Port: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\nX-Forwarded-Proto: http\nX-Forwarded-Server: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8.8")]),t._v(".8.8\nX-Real-Ip: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),t._v(".0.1\n")])])]),s("p",[t._v("服务正常访问。此时如果把 "),s("code",[t._v("Host")]),t._v(" 配置为自己的域名，则已经可以使用自己的域名来提供服务")]),t._v(" "),s("h2",{attrs:{id:"配置文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置文件"}},[t._v("#")]),t._v(" 配置文件")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://docs.traefik.io/assets/img/static-dynamic-configuration.png",alt:""}})]),t._v(" "),s("p",[s("code",[t._v("traefik")]),t._v(" 一般需要一个配置文件来管理路由，服务，证书等。我们可以通过 "),s("code",[t._v("docker")]),t._v(" 启动 "),s("code",[t._v("traefik")]),t._v(" 时来挂载配置文件，"),s("code",[t._v("docker-compose.yaml")]),t._v(" 文件如下")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3'")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("traefik")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" traefik"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("v2.0\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"80:80"')]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"8080:8080"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ./traefik.toml"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/etc/traefik/traefik.toml\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /var/run/docker.sock"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/var/run/docker.sock\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"traefik.http.routers.api.rule=Host(`traefik..com`)"')]),t._v("\n")])])]),s("p",[t._v("基本配置文件可以通过 "),s("a",{attrs:{href:"https://raw.githubusercontent.com/containous/traefik/master/traefik.sample.toml",target:"_blank",rel:"noopener noreferrer"}},[t._v("traefik.sample.toml"),s("OutboundLink")],1),t._v(" 获取")]),t._v(" "),s("p",[t._v("一个简单的配置文件及释义如下")]),t._v(" "),s("h3",{attrs:{id:"docker"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#docker"}},[t._v("#")]),t._v(" docker")]),t._v(" "),s("div",{staticClass:"language-toml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-toml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("providers.docker")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("endpoint")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"unix:///var/run/docker.sock"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("defaultRule")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Host(`{{ normalize .Name }}.shanyue.local`)"')]),t._v("\n")])])]),s("p",[t._v("如果没有配置 "),s("code",[t._v("Rule")]),t._v("，将默认通过 "),s("code",[t._v("<Name>.shanyue.local")]),t._v(" 的形式发现路由")]),t._v(" "),s("h3",{attrs:{id:"日志"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#日志"}},[t._v("#")]),t._v(" 日志")]),t._v(" "),s("div",{staticClass:"language-toml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-toml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("accessLog")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("filePath")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"./traefik-access.json"')]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("format")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"json"')]),t._v("\n")])])]),s("p",[t._v("日志文件配置为 "),s("code",[t._v("json")]),t._v(" 格式，结构化数据方便调试")]),t._v(" "),s("h3",{attrs:{id:"entrypoint"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#entrypoint"}},[t._v("#")]),t._v(" entryPoint")]),t._v(" "),s("div",{staticClass:"language-toml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-toml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("entryPoints")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("entryPoints.web")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("address")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('":80"')]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("entryPoints.web-secure")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("address")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('":443"')]),t._v("\n")])])]),s("p",[t._v("考虑到隐私以及安全，不对外公开的服务可以配置 "),s("code",[t._v("Basic Auth")]),t._v("，"),s("code",[t._v("Digest Auth")]),t._v(" 或者 "),s("code",[t._v("WhiteList")]),t._v("，或者直接搭建 VPN，在内网内进行访问。至于 "),s("code",[t._v("Basic Auth")]),t._v(" 等，可以参考 "),s("a",{attrs:{href:"https://docs.traefik.io/middlewares/overview/",target:"_blank",rel:"noopener noreferrer"}},[t._v("traefik middlewares"),s("OutboundLink")],1)]),t._v(" "),s("h3",{attrs:{id:"prometheus-metrics"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#prometheus-metrics"}},[t._v("#")]),t._v(" prometheus metrics")]),t._v(" "),s("div",{staticClass:"language-toml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-toml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("metrics.prometheus")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("buckets")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key property"}},[t._v("entryPoint")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"metrics"')]),t._v("\n")])])]),s("p",[s("a",{attrs:{href:"https://prometheus.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Prometheus"),s("OutboundLink")],1),t._v(" 作为时序数据库，可以用来监控 traefik 的日志，支持更加灵活的查询，报警以及可视化。traefik 默认设置 prometheus 作为日志收集工具。另外可以使用 "),s("code",[t._v("grafana")]),t._v(" 做为 "),s("code",[t._v("prometheus")]),t._v(" 的可视化工具。")]),t._v(" "),s("h2",{attrs:{id:"docker-provider，router-and-service"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#docker-provider，router-and-service"}},[t._v("#")]),t._v(" Docker Provider，Router and Service")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://docs.traefik.io/assets/img/architecture-overview.png",alt:"traefik architecture"}})]),t._v(" "),s("ul",[s("li",[s("code",[t._v("Providers")]),t._v(" 服务提供者，如 docker，如一个 http service")]),t._v(" "),s("li",[s("code",[t._v("Routers")]),t._v(" 分析请求的 "),s("code",[t._v("Host")]),t._v("，"),s("code",[t._v("Header")]),t._v(" 或者 "),s("code",[t._v("Path")])]),t._v(" "),s("li",[s("code",[t._v("Services")]),t._v(" 选择合适的 "),s("code",[t._v("Provider")]),t._v(" (负载均衡等)")])]),t._v(" "),s("p",[t._v("我们使用 "),s("code",[t._v("Docker")]),t._v(" 作为 "),s("code",[t._v("Provider")]),t._v("，而 "),s("code",[t._v("Router")]),t._v(" 与 "),s("code",[t._v("Service")]),t._v(" 可以通过 "),s("code",[t._v("container labels")]),t._v(" 来进行配置，我们一般使用 "),s("code",[t._v("docker-compose.yaml")]),t._v(" 中的 "),s("code",[t._v("labels")]),t._v(" 来配置")]),t._v(" "),s("p",[t._v("我们可以通过 "),s("code",[t._v("traefik.http.routers.<container-name>.rule")]),t._v(" 来配置路由规则，类似与 "),s("code",[t._v("nginx")]),t._v(" 中的 "),s("code",[t._v("location")])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"traefik.http.routers.blog.rule=Host(`traefik.io`) || (Host(`containo.us`) && Path(`/traefik`))"')]),t._v("\n")])])]),s("h3",{attrs:{id:"负载均衡"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#负载均衡"}},[t._v("#")]),t._v(" 负载均衡")]),t._v(" "),s("p",[t._v("如果要为 "),s("code",[t._v("docker provider")]),t._v(" 进行负载均衡怎么办?")]),t._v(" "),s("p",[t._v("只需要使用 "),s("code",[t._v("docker-compose up --scale")]),t._v(" 对容器横向扩容即可完成")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ docker-compose up --scale "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("whoami")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("\nWARNING: The scale "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("command")]),t._v(" is deprecated. Use the up "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("command")]),t._v(" with the --scale flag instead.\nStarting whoami_whoami_1 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(". "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("done")]),t._v("\nCreating whoami_whoami_2 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(". "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("done")]),t._v("\nCreating whoami_whoami_3 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(". "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("done")]),t._v("\n")])])]),s("p",[t._v("在 "),s("code",[t._v("traefik dashboard")]),t._v(" 中查看该 "),s("code",[t._v("service")]),t._v("时，已负载到三个容器")]),t._v(" "),s("h2",{attrs:{id:"traefik-dashboard"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#traefik-dashboard"}},[t._v("#")]),t._v(" Traefik Dashboard")]),t._v(" "),s("p",[s("code",[t._v("traefik")]),t._v(" 默认有一个 "),s("code",[t._v("dashboard")]),t._v("，通过 "),s("code",[t._v(":8080")]),t._v(" 端口暴露出去。我们可以在浏览器中直接通过 "),s("code",[t._v("<IP>:8080")]),t._v(" 访问，但是")]),t._v(" "),s("ol",[s("li",[t._v("使用 "),s("code",[t._v("IP")]),t._v(" 地址肯定不是特别方便，此时我们可以配置 "),s("code",[t._v("Host")])]),t._v(" "),s("li",[t._v("在公网环境下访问有安全性问题，此时可以配置 "),s("code",[t._v("basicAuth")]),t._v("，"),s("code",[t._v("digestAuth")]),t._v("，"),s("code",[t._v("IpWhiteList")]),t._v(" 或者 "),s("code",[t._v("openVPN")])])]),t._v(" "),s("p",[t._v("再次更改 "),s("code",[t._v("traefik")]),t._v(" 的 "),s("code",[t._v("docker-compose.yaml")]),t._v(" 文件如下：")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3'")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("reverse-proxy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" traefik"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("v2.0\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"80:80"')]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"8080:8080"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ./traefik.toml"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/etc/traefik/traefik.toml\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /var/run/docker.sock"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/var/run/docker.sock\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("container_name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" traefik\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"traefik.http.routers.api.rule=Host(`traefik.shanyue.local`)"')]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"traefik.http.routers.api.service=api@internal"')]),t._v("\n")])])]),s("p",[t._v("此时可以通过 "),s("code",[t._v("traefik.shanyue.local")]),t._v(" 来访问 "),s("code",[t._v("dashboard")])]),t._v(" "),s("blockquote",[s("p",[t._v("Q: 我们如何配置 DNS 服务器来使得 "),s("code",[t._v("traefik.shanyue.local")]),t._v(" 可供集群内部使用")])]),t._v(" "),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("p",[t._v("使用 "),s("code",[t._v("docker-compose.yaml")]),t._v(" 部署 "),s("code",[t._v("traefik")]),t._v("，部署文件文件如下")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3'")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("reverse-proxy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" traefik"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("v2.0\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"80:80"')]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"8080:8080"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ./traefik.toml"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/etc/traefik/traefik.toml\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /var/run/docker.sock"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/var/run/docker.sock\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("container_name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" traefik\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"traefik.http.routers.api.rule=Host(`traefik.shanyue.local`)"')]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"traefik.http.routers.api.service=api@internal"')]),t._v("\n")])])]),s("p",[s("code",[t._v("traefik")]),t._v(" 的配置文件可以通过 "),s("a",{attrs:{href:"https://raw.githubusercontent.com/containous/traefik/master/traefik.sample.toml",target:"_blank",rel:"noopener noreferrer"}},[t._v("traefik.sample.toml"),s("OutboundLink")],1),t._v(" 获取")]),t._v(" "),s("p",[t._v("当使用 "),s("code",[t._v("docker")]),t._v(" 部署完成 "),s("code",[t._v("traefik")]),t._v(" 并且配置好配置文件后。如果想要使用 "),s("code",[t._v("docker-compose")]),t._v(" 部署一个新的应用时只需要")]),t._v(" "),s("ol",[s("li",[t._v("添加几行 "),s("code",[t._v("container labels")])]),t._v(" "),s("li",[t._v("添加 "),s("code",[t._v("traefik")]),t._v(" 容器所使用的网络")])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3'")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 该镜像会暴露出自身的 `header` 信息")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("whoami")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" containous/whoami\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 设置Host 为 whoami.docker.localhost 进行域名访问")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"traefik.http.routers.whoami.rule=Host(`whoami.docker.localhost`)"')]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 使用已存在的 traefik 的 network")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("networks")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("default")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("external")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" traefik_default\n")])])]),s("h2",{attrs:{id:"下一步"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#下一步"}},[t._v("#")]),t._v(" 下一步")]),t._v(" "),s("p",[t._v("当我们访问集群内部服务，如数据库，缓存，"),s("code",[t._v("traefik Dashboard")]),t._v("，"),s("code",[t._v("gitlab")]),t._v(" 时，如果直接暴露在公网中，则会造成很大安全隐患，此时我们应该如何处理呢？")])])}),[],!1,null,null,null);a.default=n.exports}}]);