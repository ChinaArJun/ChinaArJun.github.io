(window.webpackJsonp=window.webpackJsonp||[]).push([[312],{890:function(e,t,r){"use strict";r.r(t);var a=r(44),n=Object(a.a)({},(function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[r("h1",{attrs:{id:"_4-5-åŸºäº-ca-çš„-tls-è¯ä¹¦è®¤è¯"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_4-5-åŸºäº-ca-çš„-tls-è¯ä¹¦è®¤è¯"}},[e._v("#")]),e._v(" 4.5 åŸºäº CA çš„ TLS è¯ä¹¦è®¤è¯")]),e._v(" "),r("p",[e._v("é¡¹ç›®åœ°å€ï¼šhttps://github.com/EDDYCJY/go-grpc-example")]),e._v(" "),r("h2",{attrs:{id:"å‰è¨€"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#å‰è¨€"}},[e._v("#")]),e._v(" å‰è¨€")]),e._v(" "),r("p",[e._v("åœ¨ä¸Šä¸€ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ä¸ªé—®é¢˜ã€‚å°±æ˜¯å¦‚ä½•ä¿è¯è¯ä¹¦çš„å¯é æ€§å’Œæœ‰æ•ˆæ€§ï¼Ÿä½ å¦‚ä½•ç¡®å®šä½  Serverã€Client çš„è¯ä¹¦æ˜¯å¯¹çš„å‘¢ï¼Ÿ")]),e._v(" "),r("h2",{attrs:{id:"ca"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#ca"}},[e._v("#")]),e._v(" CA")]),e._v(" "),r("p",[e._v("ä¸ºäº†ä¿è¯è¯ä¹¦çš„å¯é æ€§å’Œæœ‰æ•ˆæ€§ï¼Œåœ¨è¿™é‡Œå¯å¼•å…¥ CA é¢å‘çš„æ ¹è¯ä¹¦çš„æ¦‚å¿µã€‚å…¶éµå®ˆ X.509 æ ‡å‡†")]),e._v(" "),r("h3",{attrs:{id:"æ ¹è¯ä¹¦"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#æ ¹è¯ä¹¦"}},[e._v("#")]),e._v(" æ ¹è¯ä¹¦")]),e._v(" "),r("p",[e._v("æ ¹è¯ä¹¦ï¼ˆroot certificateï¼‰æ˜¯å±äºæ ¹è¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼‰çš„å…¬é’¥è¯ä¹¦ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡éªŒè¯ CA çš„ç­¾åä»è€Œä¿¡ä»» CA ï¼Œä»»ä½•äººéƒ½å¯ä»¥å¾—åˆ° CA çš„è¯ä¹¦ï¼ˆå«å…¬é’¥ï¼‰ï¼Œç”¨ä»¥éªŒè¯å®ƒæ‰€ç­¾å‘çš„è¯ä¹¦ï¼ˆå®¢æˆ·ç«¯ã€æœåŠ¡ç«¯ï¼‰")]),e._v(" "),r("p",[e._v("å®ƒåŒ…å«çš„æ–‡ä»¶å¦‚ä¸‹ï¼š")]),e._v(" "),r("ul",[r("li",[e._v("å…¬é’¥")]),e._v(" "),r("li",[e._v("å¯†é’¥")])]),e._v(" "),r("h3",{attrs:{id:"ç”Ÿæˆ-key"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#ç”Ÿæˆ-key"}},[e._v("#")]),e._v(" ç”Ÿæˆ Key")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("openssl genrsa -out ca.key 2048\n")])])]),r("h3",{attrs:{id:"ç”Ÿæˆå¯†é’¥"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#ç”Ÿæˆå¯†é’¥"}},[e._v("#")]),e._v(" ç”Ÿæˆå¯†é’¥")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("openssl req -new -x509 -days 7200 -key ca.key -out ca.pem\n")])])]),r("h4",{attrs:{id:"å¡«å†™ä¿¡æ¯"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#å¡«å†™ä¿¡æ¯"}},[e._v("#")]),e._v(" å¡«å†™ä¿¡æ¯")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("Country Name (2 letter code) []:\nState or Province Name (full name) []:\nLocality Name (eg, city) []:\nOrganization Name (eg, company) []:\nOrganizational Unit Name (eg, section) []:\nCommon Name (eg, fully qualified host name) []:go-grpc-example\nEmail Address []:\n")])])]),r("h3",{attrs:{id:"server"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#server"}},[e._v("#")]),e._v(" Server")]),e._v(" "),r("h4",{attrs:{id:"ç”Ÿæˆ-csr"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#ç”Ÿæˆ-csr"}},[e._v("#")]),e._v(" ç”Ÿæˆ CSR")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("openssl req -new -key server.key -out server.csr\n")])])]),r("h5",{attrs:{id:"å¡«å†™ä¿¡æ¯-2"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#å¡«å†™ä¿¡æ¯-2"}},[e._v("#")]),e._v(" å¡«å†™ä¿¡æ¯")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("Country Name (2 letter code) []:\nState or Province Name (full name) []:\nLocality Name (eg, city) []:\nOrganization Name (eg, company) []:\nOrganizational Unit Name (eg, section) []:\nCommon Name (eg, fully qualified host name) []:go-grpc-example\nEmail Address []:\n\nPlease enter the following 'extra' attributes\nto be sent with your certificate request\nA challenge password []:\n")])])]),r("p",[e._v("CSR æ˜¯ Cerificate Signing Request çš„è‹±æ–‡ç¼©å†™ï¼Œä¸ºè¯ä¹¦è¯·æ±‚æ–‡ä»¶ã€‚ä¸»è¦ä½œç”¨æ˜¯ CA ä¼šåˆ©ç”¨ CSR æ–‡ä»¶è¿›è¡Œç­¾åä½¿å¾—æ”»å‡»è€…æ— æ³•ä¼ªè£…æˆ–ç¯¡æ”¹åŸæœ‰è¯ä¹¦")]),e._v(" "),r("h4",{attrs:{id:"åŸºäº-ca-ç­¾å‘"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#åŸºäº-ca-ç­¾å‘"}},[e._v("#")]),e._v(" åŸºäº CA ç­¾å‘")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("openssl x509 -req -sha256 -CA ca.pem -CAkey ca.key -CAcreateserial -days 3650 -in server.csr -out server.pem\n")])])]),r("h3",{attrs:{id:"client"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#client"}},[e._v("#")]),e._v(" Client")]),e._v(" "),r("h3",{attrs:{id:"ç”Ÿæˆ-key-2"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#ç”Ÿæˆ-key-2"}},[e._v("#")]),e._v(" ç”Ÿæˆ Key")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("openssl ecparam -genkey -name secp384r1 -out client.key\n")])])]),r("h3",{attrs:{id:"ç”Ÿæˆ-csr-2"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#ç”Ÿæˆ-csr-2"}},[e._v("#")]),e._v(" ç”Ÿæˆ CSR")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("openssl req -new -key client.key -out client.csr\n")])])]),r("h4",{attrs:{id:"åŸºäº-ca-ç­¾å‘-2"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#åŸºäº-ca-ç­¾å‘-2"}},[e._v("#")]),e._v(" åŸºäº CA ç­¾å‘")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("openssl x509 -req -sha256 -CA ca.pem -CAkey ca.key -CAcreateserial -days 3650 -in client.csr -out client.pem\n")])])]),r("h3",{attrs:{id:"æ•´ç†ç›®å½•"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#æ•´ç†ç›®å½•"}},[e._v("#")]),e._v(" æ•´ç†ç›®å½•")]),e._v(" "),r("p",[e._v("è‡³æ­¤æˆ‘ä»¬ç”Ÿæˆäº†ä¸€å †æ–‡ä»¶ï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹ç›®å½•ç»“æ„å­˜æ”¾ï¼š")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("$ tree conf \nconf\nâ”œâ”€â”€ ca.key\nâ”œâ”€â”€ ca.pem\nâ”œâ”€â”€ ca.srl\nâ”œâ”€â”€ client\nâ”‚Â Â  â”œâ”€â”€ client.csr\nâ”‚Â Â  â”œâ”€â”€ client.key\nâ”‚Â Â  â””â”€â”€ client.pem\nâ””â”€â”€ server\n    â”œâ”€â”€ server.csr\n    â”œâ”€â”€ server.key\n    â””â”€â”€ server.pem\n")])])]),r("p",[e._v("å¦å¤–æœ‰ä¸€äº›æ–‡ä»¶æ˜¯ä¸åº”è¯¥å‡ºç°åœ¨ä»“åº“å†…ï¼Œåº”å½“ä¿å¯†æˆ–åˆ é™¤çš„ã€‚ä½†ä¸ºäº†çœŸå®æ¼”ç¤ºæ‰€ä»¥ä¿ç•™ç€ï¼ˆæ•²é»‘æ¿ï¼‰")]),e._v(" "),r("h2",{attrs:{id:"grpc"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#grpc"}},[e._v("#")]),e._v(" gRPC")]),e._v(" "),r("p",[e._v("æ¥ä¸‹æ¥å°†æ­£å¼å¼€å§‹é’ˆå¯¹ gRPC è¿›è¡Œç¼–ç ï¼Œæ”¹é€ ä¸Šä¸€ç« èŠ‚çš„ä»£ç ã€‚ç›®æ ‡æ˜¯åŸºäº CA è¿›è¡Œ TLS è®¤è¯ ğŸ¤«")]),e._v(" "),r("h3",{attrs:{id:"server-2"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#server-2"}},[e._v("#")]),e._v(" Server")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('package main\n\nimport (\n\t"context"\n\t"log"\n\t"net"\n\t"crypto/tls"\n\t"crypto/x509"\n\t"io/ioutil"\n\n\t"google.golang.org/grpc"\n\t"google.golang.org/grpc/credentials"\n\n\tpb "github.com/EDDYCJY/go-grpc-example/proto"\n)\n\n...\n\nconst PORT = "9001"\n\nfunc main() {\n\tcert, err := tls.LoadX509KeyPair("../../conf/server/server.pem", "../../conf/server/server.key")\n\tif err != nil {\n\t\tlog.Fatalf("tls.LoadX509KeyPair err: %v", err)\n\t}\n\n\tcertPool := x509.NewCertPool()\n\tca, err := ioutil.ReadFile("../../conf/ca.pem")\n\tif err != nil {\n\t\tlog.Fatalf("ioutil.ReadFile err: %v", err)\n\t}\n\n\tif ok := certPool.AppendCertsFromPEM(ca); !ok {\n\t\tlog.Fatalf("certPool.AppendCertsFromPEM err")\n\t}\n\n\tc := credentials.NewTLS(&tls.Config{\n\t\tCertificates: []tls.Certificate{cert},\n\t\tClientAuth:   tls.RequireAndVerifyClientCert,\n\t\tClientCAs:    certPool,\n\t})\n\n\tserver := grpc.NewServer(grpc.Creds(c))\n\tpb.RegisterSearchServiceServer(server, &SearchService{})\n\n\tlis, err := net.Listen("tcp", ":"+PORT)\n\tif err != nil {\n\t\tlog.Fatalf("net.Listen err: %v", err)\n\t}\n\n\tserver.Serve(lis)\n}\n')])])]),r("ul",[r("li",[e._v("tls.LoadX509KeyPair()ï¼šä»è¯ä¹¦ç›¸å…³æ–‡ä»¶ä¸­"),r("strong",[e._v("è¯»å–")]),e._v("å’Œ"),r("strong",[e._v("è§£æ")]),e._v("ä¿¡æ¯ï¼Œå¾—åˆ°è¯ä¹¦å…¬é’¥ã€å¯†é’¥å¯¹")])]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("func LoadX509KeyPair(certFile, keyFile string) (Certificate, error) {\n\tcertPEMBlock, err := ioutil.ReadFile(certFile)\n\tif err != nil {\n\t\treturn Certificate{}, err\n\t}\n\tkeyPEMBlock, err := ioutil.ReadFile(keyFile)\n\tif err != nil {\n\t\treturn Certificate{}, err\n\t}\n\treturn X509KeyPair(certPEMBlock, keyPEMBlock)\n}\n")])])]),r("ul",[r("li",[e._v("x509.NewCertPool()ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ã€ç©ºçš„ CertPool")]),e._v(" "),r("li",[e._v("certPool.AppendCertsFromPEM()ï¼šå°è¯•è§£ææ‰€ä¼ å…¥çš„ PEM ç¼–ç çš„è¯ä¹¦ã€‚å¦‚æœè§£ææˆåŠŸä¼šå°†å…¶åŠ åˆ° CertPool ä¸­ï¼Œä¾¿äºåé¢çš„ä½¿ç”¨")]),e._v(" "),r("li",[e._v("credentials.NewTLSï¼šæ„å»ºåŸºäº TLS çš„ TransportCredentials é€‰é¡¹")]),e._v(" "),r("li",[e._v("tls.Configï¼šConfig ç»“æ„ç”¨äºé…ç½® TLS å®¢æˆ·ç«¯æˆ–æœåŠ¡å™¨")])]),e._v(" "),r("p",[e._v("åœ¨ Serverï¼Œå…±ä½¿ç”¨äº†ä¸‰ä¸ª Config é…ç½®é¡¹ï¼š")]),e._v(" "),r("p",[e._v("ï¼ˆ1ï¼‰Certificatesï¼šè®¾ç½®è¯ä¹¦é“¾ï¼Œå…è®¸åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª")]),e._v(" "),r("p",[e._v("ï¼ˆ2ï¼‰ClientAuthï¼šè¦æ±‚å¿…é¡»æ ¡éªŒå®¢æˆ·ç«¯çš„è¯ä¹¦ã€‚å¯ä»¥æ ¹æ®å®é™…æƒ…å†µé€‰ç”¨ä»¥ä¸‹å‚æ•°ï¼š")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("const (\n\tNoClientCert ClientAuthType = iota\n\tRequestClientCert\n\tRequireAnyClientCert\n\tVerifyClientCertIfGiven\n\tRequireAndVerifyClientCert\n)\n")])])]),r("p",[e._v("ï¼ˆ3ï¼‰ClientCAsï¼šè®¾ç½®æ ¹è¯ä¹¦çš„é›†åˆï¼Œæ ¡éªŒæ–¹å¼ä½¿ç”¨ ClientAuth ä¸­è®¾å®šçš„æ¨¡å¼")]),e._v(" "),r("h3",{attrs:{id:"client-2"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#client-2"}},[e._v("#")]),e._v(" Client")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('package main\n\nimport (\n\t"context"\n\t"crypto/tls"\n\t"crypto/x509"\n\t"io/ioutil"\n\t"log"\n\n\t"google.golang.org/grpc"\n\t"google.golang.org/grpc/credentials"\n\n\tpb "github.com/EDDYCJY/go-grpc-example/proto"\n)\n\nconst PORT = "9001"\n\nfunc main() {\n\tcert, err := tls.LoadX509KeyPair("../../conf/client/client.pem", "../../conf/client/client.key")\n\tif err != nil {\n\t\tlog.Fatalf("tls.LoadX509KeyPair err: %v", err)\n\t}\n\n\tcertPool := x509.NewCertPool()\n\tca, err := ioutil.ReadFile("../../conf/ca.pem")\n\tif err != nil {\n\t\tlog.Fatalf("ioutil.ReadFile err: %v", err)\n\t}\n\n\tif ok := certPool.AppendCertsFromPEM(ca); !ok {\n\t\tlog.Fatalf("certPool.AppendCertsFromPEM err")\n\t}\n\n\tc := credentials.NewTLS(&tls.Config{\n\t\tCertificates: []tls.Certificate{cert},\n\t\tServerName:   "go-grpc-example",\n\t\tRootCAs:      certPool,\n\t})\n\n\tconn, err := grpc.Dial(":"+PORT, grpc.WithTransportCredentials(c))\n\tif err != nil {\n\t\tlog.Fatalf("grpc.Dial err: %v", err)\n\t}\n\tdefer conn.Close()\n\n\tclient := pb.NewSearchServiceClient(conn)\n\tresp, err := client.Search(context.Background(), &pb.SearchRequest{\n\t\tRequest: "gRPC",\n\t})\n\tif err != nil {\n\t\tlog.Fatalf("client.Search err: %v", err)\n\t}\n\n\tlog.Printf("resp: %s", resp.GetResponse())\n}\n')])])]),r("p",[e._v("åœ¨ Client ä¸­ç»å¤§éƒ¨åˆ†ä¸ Server ä¸€è‡´ï¼Œä¸åŒç‚¹çš„åœ°æ–¹æ˜¯ï¼Œåœ¨ Client è¯·æ±‚ Server ç«¯æ—¶ï¼ŒClient ç«¯ä¼šä½¿ç”¨æ ¹è¯ä¹¦å’Œ ServerName å»å¯¹ Server ç«¯è¿›è¡Œæ ¡éªŒ")]),e._v(" "),r("p",[e._v("ç®€å•æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š")]),e._v(" "),r("ol",[r("li",[e._v("Client é€šè¿‡è¯·æ±‚å¾—åˆ° Server ç«¯çš„è¯ä¹¦")]),e._v(" "),r("li",[e._v("ä½¿ç”¨ CA è®¤è¯çš„æ ¹è¯ä¹¦å¯¹ Server ç«¯çš„è¯ä¹¦è¿›è¡Œå¯é æ€§ã€æœ‰æ•ˆæ€§ç­‰æ ¡éªŒ")]),e._v(" "),r("li",[e._v("æ ¡éªŒ ServerName æ˜¯å¦å¯ç”¨ã€æœ‰æ•ˆ")])]),e._v(" "),r("p",[e._v("å½“ç„¶äº†ï¼Œåœ¨è®¾ç½®äº† "),r("code",[e._v("tls.RequireAndVerifyClientCert")]),e._v(" æ¨¡å¼çš„æƒ…å†µä¸‹ï¼ŒServer ä¹Ÿä¼šä½¿ç”¨ CA è®¤è¯çš„æ ¹è¯ä¹¦å¯¹ Client ç«¯çš„è¯ä¹¦è¿›è¡Œå¯é æ€§ã€æœ‰æ•ˆæ€§ç­‰æ ¡éªŒã€‚ä¹Ÿå°±æ˜¯ä¸¤è¾¹éƒ½ä¼šè¿›è¡Œæ ¡éªŒï¼Œæå¤§çš„ä¿è¯äº†å®‰å…¨æ€§ ğŸ‘")]),e._v(" "),r("h3",{attrs:{id:"éªŒè¯"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#éªŒè¯"}},[e._v("#")]),e._v(" éªŒè¯")]),e._v(" "),r("p",[e._v("é‡æ–°å¯åŠ¨ server.go å’Œæ‰§è¡Œ client.goï¼ŒæŸ¥çœ‹å“åº”ç»“æœæ˜¯å¦æ­£å¸¸")]),e._v(" "),r("h2",{attrs:{id:"æ€»ç»“"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#æ€»ç»“"}},[e._v("#")]),e._v(" æ€»ç»“")]),e._v(" "),r("p",[e._v("åœ¨æœ¬ç« èŠ‚ï¼Œæˆ‘ä»¬ä½¿ç”¨ CA é¢å‘çš„æ ¹è¯ä¹¦å¯¹å®¢æˆ·ç«¯ã€æœåŠ¡ç«¯çš„è¯ä¹¦è¿›è¡Œäº†ç­¾å‘ã€‚è¿›ä¸€æ­¥çš„æé«˜äº†ä¸¤è€…çš„é€šè®¯å®‰å…¨")]),e._v(" "),r("p",[e._v("è¿™å›æ˜¯çœŸçš„å¤§åŠŸå‘Šæˆäº†ï¼")]),e._v(" "),r("h2",{attrs:{id:"å‚è€ƒ"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#å‚è€ƒ"}},[e._v("#")]),e._v(" å‚è€ƒ")]),e._v(" "),r("h3",{attrs:{id:"æœ¬ç³»åˆ—ç¤ºä¾‹ä»£ç "}},[r("a",{staticClass:"header-anchor",attrs:{href:"#æœ¬ç³»åˆ—ç¤ºä¾‹ä»£ç "}},[e._v("#")]),e._v(" æœ¬ç³»åˆ—ç¤ºä¾‹ä»£ç ")]),e._v(" "),r("ul",[r("li",[r("a",{attrs:{href:"https://github.com/EDDYCJY/go-grpc-example",target:"_blank",rel:"noopener noreferrer"}},[e._v("go-grpc-example"),r("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=n.exports}}]);