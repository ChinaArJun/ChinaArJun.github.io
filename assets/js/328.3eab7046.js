(window.webpackJsonp=window.webpackJsonp||[]).push([[328],{906:function(t,a,e){"use strict";e.r(a);var s=e(44),v=Object(s.a)({},(function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"_7-3-æ·±å…¥ç†è§£-go-mapï¼šåˆå§‹åŒ–å’Œè®¿é—®å…ƒç´ "}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_7-3-æ·±å…¥ç†è§£-go-mapï¼šåˆå§‹åŒ–å’Œè®¿é—®å…ƒç´ "}},[t._v("#")]),t._v(" 7.3 æ·±å…¥ç†è§£ Go mapï¼šåˆå§‹åŒ–å’Œè®¿é—®å…ƒç´ ")]),t._v(" "),e("p",[t._v("ä»æœ¬æ–‡å¼€å§‹å’±ä»¬ä¸€èµ·æ¢ç´¢ Go map é‡Œé¢çš„å¥¥å¦™å§ï¼Œçœ‹çœ‹å®ƒçš„å†…åœ¨æ˜¯æ€ä¹ˆæ„æˆçš„ï¼Œåˆåˆ†åˆ«æœ‰ä»€ä¹ˆå€¼å¾—ç•™æ„çš„åœ°æ–¹ï¼Ÿ")]),t._v(" "),e("p",[t._v("ç¬¬ä¸€ç¯‡å°†æ¢è®¨"),e("strong",[t._v("åˆå§‹åŒ–å’Œè®¿é—®å…ƒç´ ")]),t._v("ç›¸å…³æ¿å—ï¼Œå’±ä»¬å¸¦ç€ç–‘é—®å»å­¦ä¹ ï¼Œä¾‹å¦‚ï¼š")]),t._v(" "),e("ul",[e("li",[t._v("åˆå§‹åŒ–çš„æ—¶å€™ä¼šé©¬ä¸Šåˆ†é…å†…å­˜å—ï¼Ÿ")]),t._v(" "),e("li",[t._v("åº•å±‚æ•°æ®æ˜¯å¦‚ä½•å­˜å‚¨çš„ï¼Ÿ")]),t._v(" "),e("li",[t._v("åº•å±‚æ˜¯å¦‚ä½•ä½¿ç”¨ key å»å¯»æ‰¾æ•°æ®çš„ï¼Ÿ")]),t._v(" "),e("li",[t._v("åº•å±‚æ˜¯ç”¨ä»€ä¹ˆæ–¹å¼è§£å†³å“ˆå¸Œå†²çªçš„ï¼Ÿ")]),t._v(" "),e("li",[t._v("æ•°æ®ç±»å‹é‚£ä¹ˆå¤šï¼Œåº•å±‚åˆæ˜¯æ€ä¹ˆå¤„ç†çš„å‘¢ï¼Ÿ")])]),t._v(" "),e("p",[t._v("...")]),t._v(" "),e("h2",{attrs:{id:"æ•°æ®ç»“æ„"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#æ•°æ®ç»“æ„"}},[t._v("#")]),t._v(" æ•°æ®ç»“æ„")]),t._v(" "),e("p",[t._v("é¦–å…ˆæˆ‘ä»¬ä¸€èµ·çœ‹çœ‹ Go map çš„åŸºç¡€æ•°æ®ç»“æ„ï¼Œå…ˆæœ‰ä¸€ä¸ªå¤§è‡´çš„å°è±¡")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://i.imgur.com/EAJgaWk.png",alt:"image"}})]),t._v(" "),e("h3",{attrs:{id:"hmap"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#hmap"}},[t._v("#")]),t._v(" hmap")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("type hmap struct {\n\tcount     int \n\tflags     uint8\n\tB         uint8\n\tnoverflow uint16\n\thash0     uint32\n\tbuckets    unsafe.Pointer\n\toldbuckets unsafe.Pointer\n\tnevacuate  uintptr \n\textra *mapextra\n}\n\ntype mapextra struct {\n\toverflow    *[]*bmap\n\toldoverflow *[]*bmap\n\tnextOverflow *bmap\n}\n")])])]),e("ul",[e("li",[t._v("countï¼šmap çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯ len() çš„å€¼ã€‚ä»£æŒ‡ map ä¸­çš„é”®å€¼å¯¹ä¸ªæ•°")]),t._v(" "),e("li",[t._v("flagsï¼šçŠ¶æ€æ ‡è¯†ï¼Œä¸»è¦æ˜¯ goroutine å†™å…¥å’Œæ‰©å®¹æœºåˆ¶çš„ç›¸å…³çŠ¶æ€æ§åˆ¶ã€‚å¹¶å‘è¯»å†™çš„åˆ¤æ–­æ¡ä»¶ä¹‹ä¸€å°±æ˜¯è¯¥å€¼")]),t._v(" "),e("li",[t._v("Bï¼šæ¡¶ï¼Œæœ€å¤§å¯å®¹çº³çš„å…ƒç´ æ•°é‡ï¼Œå€¼ä¸º "),e("strong",[t._v("è´Ÿè½½å› å­ï¼ˆé»˜è®¤ 6.5ï¼‰ * 2 ^ B")]),t._v("ï¼Œæ˜¯ 2 çš„æŒ‡æ•°")]),t._v(" "),e("li",[t._v("noverflowï¼šæº¢å‡ºæ¡¶çš„æ•°é‡")]),t._v(" "),e("li",[t._v("hash0ï¼šå“ˆå¸Œå› å­")]),t._v(" "),e("li",[t._v("bucketsï¼šä¿å­˜å½“å‰æ¡¶æ•°æ®çš„æŒ‡é’ˆåœ°å€ï¼ˆæŒ‡å‘ä¸€æ®µè¿ç»­çš„å†…å­˜åœ°å€ï¼Œä¸»è¦å­˜å‚¨é”®å€¼å¯¹æ•°æ®ï¼‰")]),t._v(" "),e("li",[t._v("oldbucketsï¼Œä¿å­˜æ—§æ¡¶çš„æŒ‡é’ˆåœ°å€")]),t._v(" "),e("li",[t._v("nevacuateï¼šè¿ç§»è¿›åº¦")]),t._v(" "),e("li",[t._v("extraï¼šåŸæœ‰ buckets æ»¡è½½åï¼Œä¼šå‘ç”Ÿæ‰©å®¹åŠ¨ä½œï¼Œåœ¨ Go çš„æœºåˆ¶ä¸­ä½¿ç”¨äº†å¢é‡æ‰©å®¹ï¼Œå¦‚ä¸‹ä¸ºç»†é¡¹ï¼š\n"),e("ul",[e("li",[e("code",[t._v("overflow")]),t._v(" ä¸º "),e("code",[t._v("hmap.buckets")]),t._v(" ï¼ˆå½“å‰ï¼‰æº¢å‡ºæ¡¶çš„æŒ‡é’ˆåœ°å€")]),t._v(" "),e("li",[e("code",[t._v("oldoverflow")]),t._v(" ä¸º "),e("code",[t._v("hmap.oldbuckets")]),t._v(" ï¼ˆæ—§ï¼‰æº¢å‡ºæ¡¶çš„æŒ‡é’ˆåœ°å€")]),t._v(" "),e("li",[e("code",[t._v("nextOverflow")]),t._v(" ä¸ºç©ºé—²æº¢å‡ºæ¡¶çš„æŒ‡é’ˆåœ°å€")])])])]),t._v(" "),e("p",[t._v("åœ¨è¿™é‡Œæˆ‘ä»¬è¦æ³¨æ„å‡ ç‚¹ï¼Œå¦‚ä¸‹ï¼š")]),t._v(" "),e("ol",[e("li",[t._v("å¦‚æœ keys å’Œ values éƒ½ä¸åŒ…å«æŒ‡é’ˆå¹¶ä¸”å…è®¸å†…è”çš„æƒ…å†µä¸‹ã€‚ä¼šå°† bucket æ ‡è¯†ä¸ºä¸åŒ…å«æŒ‡é’ˆï¼Œä½¿ç”¨ extra å­˜å‚¨æº¢å‡ºæ¡¶å°±å¯ä»¥é¿å… GC æ‰«ææ•´ä¸ª mapï¼ŒèŠ‚çœä¸å¿…è¦çš„å¼€é”€")]),t._v(" "),e("li",[t._v("åœ¨å‰é¢æœ‰æåˆ°ï¼ŒGo ç”¨äº†å¢é‡æ‰©å®¹ã€‚è€Œ "),e("code",[t._v("buckets")]),t._v(" å’Œ "),e("code",[t._v("oldbuckets")]),t._v(" ä¹Ÿæ˜¯ä¸æ‰©å®¹ç›¸å…³çš„è½½ä½“ï¼Œä¸€èˆ¬æƒ…å†µä¸‹åªä½¿ç”¨ "),e("code",[t._v("buckets")]),t._v("ï¼Œ"),e("code",[t._v("oldbuckets")]),t._v(" æ˜¯ä¸ºç©ºçš„ã€‚ä½†å¦‚æœæ­£åœ¨æ‰©å®¹çš„è¯ï¼Œ"),e("code",[t._v("oldbuckets")]),t._v(" ä¾¿ä¸ä¸ºç©ºï¼Œ"),e("code",[t._v("buckets")]),t._v(" çš„å¤§å°ä¹Ÿä¼šæ”¹å˜")]),t._v(" "),e("li",[t._v("å½“ "),e("code",[t._v("hint")]),t._v(" å¤§äº 8 æ—¶ï¼Œå°±ä¼šä½¿ç”¨ "),e("code",[t._v("*mapextra")]),t._v(" åšæº¢å‡ºæ¡¶ã€‚è‹¥å°äº 8ï¼Œåˆ™å­˜å‚¨åœ¨ buckets æ¡¶ä¸­")])]),t._v(" "),e("h3",{attrs:{id:"bmap"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#bmap"}},[t._v("#")]),t._v(" bmap")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://i.imgur.com/zHG1CId.png",alt:"image"}})]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("bucketCntBits = 3\nbucketCnt     = 1 << bucketCntBits\n...\ntype bmap struct {\n\ttophash [bucketCnt]uint8\n}\n")])])]),e("ul",[e("li",[t._v("tophashï¼škey çš„ hash å€¼é«˜ 8 ä½")]),t._v(" "),e("li",[t._v("keysï¼š8 ä¸ª key")]),t._v(" "),e("li",[t._v("valuesï¼š8 ä¸ª value")]),t._v(" "),e("li",[t._v("overflowï¼šä¸‹ä¸€ä¸ªæº¢å‡ºæ¡¶çš„æŒ‡é’ˆåœ°å€ï¼ˆå½“ hash å†²çªå‘ç”Ÿæ—¶ï¼‰")])]),t._v(" "),e("p",[t._v("å®é™… bmap å°±æ˜¯ buckets ä¸­çš„ bucketï¼Œä¸€ä¸ª bucket æœ€å¤šå­˜å‚¨ 8 ä¸ªé”®å€¼å¯¹")]),t._v(" "),e("h4",{attrs:{id:"tophash"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#tophash"}},[t._v("#")]),t._v(" tophash")]),t._v(" "),e("p",[t._v("tophash æ˜¯ä¸ªé•¿åº¦ä¸º 8 çš„æ•°ç»„ï¼Œä»£æŒ‡æ¡¶æœ€å¤§å¯å®¹çº³çš„é”®å€¼å¯¹ä¸º 8ã€‚")]),t._v(" "),e("p",[t._v("å­˜å‚¨æ¯ä¸ªå…ƒç´  hash å€¼çš„é«˜ 8 ä½ï¼Œå¦‚æœ "),e("code",[t._v("tophash [0] <minTopHash")]),t._v("ï¼Œåˆ™ "),e("code",[t._v("tophash [0]")]),t._v(" è¡¨ç¤ºä¸ºè¿ç§»è¿›åº¦")]),t._v(" "),e("h4",{attrs:{id:"keys-å’Œ-values"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#keys-å’Œ-values"}},[t._v("#")]),t._v(" keys å’Œ values")]),t._v(" "),e("p",[t._v("åœ¨è¿™é‡Œæˆ‘ä»¬ç•™æ„åˆ°ï¼Œå­˜å‚¨ k å’Œ v çš„è½½ä½“å¹¶ä¸æ˜¯ç”¨ "),e("code",[t._v("k/v/k/v/k/v/k/v")]),t._v(" çš„æ¨¡å¼ï¼Œè€Œæ˜¯ "),e("code",[t._v("k/k/k/k/v/v/v/v")]),t._v(" çš„å½¢å¼å»å­˜å‚¨ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("map[int64]int8\n")])])]),e("p",[t._v("åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¦‚æœæŒ‰ç…§ "),e("code",[t._v("k/v/k/v/k/v/k/v")]),t._v(" çš„å½¢å¼å­˜æ”¾çš„è¯ï¼Œè™½ç„¶æ¯ä¸ªé”®å€¼å¯¹çš„å€¼éƒ½åªå ç”¨ 1 ä¸ªå­—èŠ‚ã€‚ä½†æ˜¯å´éœ€è¦ 7 ä¸ªå¡«å……å­—èŠ‚æ¥è¡¥é½å†…å­˜ç©ºé—´ã€‚æœ€ç»ˆå°±ä¼šé€ æˆå¤§é‡çš„å†…å­˜ â€œæµªè´¹â€")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://i.imgur.com/yNWBDqD.png",alt:"image"}})]),t._v(" "),e("p",[t._v("ä½†æ˜¯å¦‚æœä»¥ "),e("code",[t._v("k/k/k/k/v/v/v/v")]),t._v(' çš„å½¢å¼å­˜æ”¾çš„è¯ï¼Œå°±èƒ½å¤Ÿè§£å†³å› å¯¹é½æ‰€ "æµªè´¹" çš„å†…å­˜ç©ºé—´')]),t._v(" "),e("p",[t._v("å› æ­¤è¿™éƒ¨åˆ†çš„æ‹†åˆ†ä¸»è¦æ˜¯è€ƒè™‘åˆ°å†…å­˜å¯¹é½çš„é—®é¢˜ï¼Œè™½ç„¶ç›¸å¯¹ä¼šå¤æ‚ä¸€ç‚¹ï¼Œä½†ä¾ç„¶å€¼å¾—å¦‚æ­¤è®¾è®¡")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://i.imgur.com/DssSFRr.png",alt:"image"}})]),t._v(" "),e("h4",{attrs:{id:"overflow"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#overflow"}},[t._v("#")]),t._v(" overflow")]),t._v(" "),e("p",[t._v("å¯èƒ½ä¼šæœ‰åŒå­¦ç–‘æƒ‘ä¸ºä»€ä¹ˆä¼šæœ‰æº¢å‡ºæ¡¶è¿™ä¸ªä¸œè¥¿ï¼Ÿå®é™…ä¸Šåœ¨ä¸å­˜åœ¨å“ˆå¸Œå†²çªçš„æƒ…å†µä¸‹ï¼Œå»æ‰æº¢å‡ºæ¡¶ï¼Œä¹Ÿå°±æ˜¯åªéœ€è¦æ¡¶ã€å“ˆå¸Œå› å­ã€å“ˆå¸Œç®—æ³•ã€‚ä¹Ÿèƒ½å®ç°ä¸€ä¸ªç®€å•çš„ hash tableã€‚ä½†æ˜¯å“ˆå¸Œå†²çªï¼ˆç¢°æ’ï¼‰æ˜¯ä¸å¯é¿å…çš„...")]),t._v(" "),e("p",[t._v("è€Œåœ¨ Go map ä¸­å½“ "),e("code",[t._v("hmap.buckets")]),t._v(" æ»¡äº†åï¼Œå°±ä¼šä½¿ç”¨æº¢å‡ºæ¡¶æ¥ç€å­˜å‚¨ã€‚æˆ‘ä»¬ç»“åˆåˆ†æå¯ç¡®å®š Go é‡‡ç”¨çš„æ˜¯æ•°ç»„ + é“¾åœ°å€æ³•è§£å†³å“ˆå¸Œå†²çª")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://i.imgur.com/uHeHP8k.png",alt:"image"}})]),t._v(" "),e("h2",{attrs:{id:"åˆå§‹åŒ–"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#åˆå§‹åŒ–"}},[t._v("#")]),t._v(" åˆå§‹åŒ–")]),t._v(" "),e("h3",{attrs:{id:"ç”¨æ³•"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ç”¨æ³•"}},[t._v("#")]),t._v(" ç”¨æ³•")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("m := make(map[int32]int32)\n")])])]),e("h3",{attrs:{id:"å‡½æ•°åŸå‹"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#å‡½æ•°åŸå‹"}},[t._v("#")]),t._v(" å‡½æ•°åŸå‹")]),t._v(" "),e("p",[t._v("é€šè¿‡é˜…è¯»æºç å¯å¾—çŸ¥ï¼Œåˆå§‹åŒ–æ–¹æ³•æœ‰å¥½å‡ ç§ã€‚å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("func makemap_small() *hmap\nfunc makemap64(t *maptype, hint int64, h *hmap) *hmap\nfunc makemap(t *maptype, hint int, h *hmap) *hmap\n")])])]),e("ul",[e("li",[t._v("makemap_smallï¼šå½“ "),e("code",[t._v("hint")]),t._v(" å°äº 8 æ—¶ï¼Œä¼šè°ƒç”¨ "),e("code",[t._v("makemap_small")]),t._v(" æ¥åˆå§‹åŒ– hmapã€‚ä¸»è¦å·®å¼‚åœ¨äºæ˜¯å¦ä¼šé©¬ä¸Šåˆå§‹åŒ– hash table")]),t._v(" "),e("li",[t._v("makemap64ï¼šå½“ "),e("code",[t._v("hint")]),t._v(" ç±»å‹ä¸º int64 æ—¶çš„ç‰¹æ®Šè½¬æ¢åŠæ ¡éªŒå¤„ç†ï¼Œåç»­å®è´¨è°ƒç”¨ "),e("code",[t._v("makemap")])]),t._v(" "),e("li",[t._v("makemapï¼šå®ç°äº†æ ‡å‡†çš„ map åˆå§‹åŒ–åŠ¨ä½œ")])]),t._v(" "),e("h3",{attrs:{id:"æºç "}},[e("a",{staticClass:"header-anchor",attrs:{href:"#æºç "}},[t._v("#")]),t._v(" æºç ")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("func makemap(t *maptype, hint int, h *hmap) *hmap {\n\tif hint < 0 || hint > int(maxSliceCap(t.bucket.size)) {\n\t\thint = 0\n\t}\n\n\tif h == nil {\n\t\th = new(hmap)\n\t}\n\th.hash0 = fastrand()\n\n\tB := uint8(0)\n\tfor overLoadFactor(hint, B) {\n\t\tB++\n\t}\n\th.B = B\n\n\tif h.B != 0 {\n\t\tvar nextOverflow *bmap\n\t\th.buckets, nextOverflow = makeBucketArray(t, h.B, nil)\n\t\tif nextOverflow != nil {\n\t\t\th.extra = new(mapextra)\n\t\t\th.extra.nextOverflow = nextOverflow\n\t\t}\n\t}\n\n\treturn h\n}\n")])])]),e("ul",[e("li",[t._v("æ ¹æ®ä¼ å…¥çš„ "),e("code",[t._v("bucket")]),t._v(" ç±»å‹ï¼Œè·å–å…¶ç±»å‹èƒ½å¤Ÿç”³è¯·çš„æœ€å¤§å®¹é‡å¤§å°ã€‚å¹¶å¯¹å…¶é•¿åº¦ "),e("code",[t._v("make(map[k]v, hint)")]),t._v(" è¿›è¡Œè¾¹ç•Œå€¼æ£€éªŒ")]),t._v(" "),e("li",[t._v("åˆå§‹åŒ– hmap")]),t._v(" "),e("li",[t._v("åˆå§‹åŒ–å“ˆå¸Œå› å­")]),t._v(" "),e("li",[t._v("æ ¹æ®ä¼ å…¥çš„ "),e("code",[t._v("hint")]),t._v("ï¼Œè®¡ç®—ä¸€ä¸ªå¯ä»¥æ”¾ä¸‹ "),e("code",[t._v("hint")]),t._v(" ä¸ªå…ƒç´ çš„æ¡¶ "),e("code",[t._v("B")]),t._v(" çš„æœ€å°å€¼")]),t._v(" "),e("li",[t._v("åˆ†é…å¹¶åˆå§‹åŒ– hash tableã€‚å¦‚æœ "),e("code",[t._v("B")]),t._v(" ä¸º 0 å°†åœ¨åç»­æ‡’æƒ°åˆ†é…æ¡¶ï¼Œå¤§äº 0 åˆ™ä¼šé©¬ä¸Šè¿›è¡Œåˆ†é…")]),t._v(" "),e("li",[t._v("è¿”å›åˆå§‹åŒ–å®Œæ¯•çš„ hmap")])]),t._v(" "),e("p",[t._v("åœ¨è¿™é‡Œå¯ä»¥æ³¨æ„åˆ°ï¼Œï¼ˆå½“ "),e("code",[t._v("hint")]),t._v(" å¤§äºç­‰äº 8 ï¼‰ç¬¬ä¸€æ¬¡åˆå§‹åŒ– map æ—¶ï¼Œå°±ä¼šé€šè¿‡è°ƒç”¨ "),e("code",[t._v("makeBucketArray")]),t._v(" å¯¹ buckets è¿›è¡Œåˆ†é…ã€‚å› æ­¤æˆ‘ä»¬å¸¸å¸¸ä¼šè¯´ï¼Œåœ¨åˆå§‹åŒ–æ—¶æŒ‡å®šä¸€ä¸ªé€‚å½“å¤§å°çš„å®¹é‡ã€‚èƒ½å¤Ÿæå‡æ€§èƒ½ã€‚")]),t._v(" "),e("p",[t._v("è‹¥è¯¥å®¹é‡è¿‡å°‘ï¼Œè€Œæ–°å¢çš„é”®å€¼å¯¹åˆå¾ˆå¤šã€‚å°±ä¼šå¯¼è‡´é¢‘ç¹çš„åˆ†é… bucketsï¼Œè¿›è¡Œæ‰©å®¹è¿ç§»ç­‰ rehash åŠ¨ä½œã€‚æœ€ç»ˆç»“æœå°±æ˜¯æ€§èƒ½ç›´æ¥çš„ä¸‹é™ï¼ˆæ•²é»‘æ¿ï¼‰")]),t._v(" "),e("p",[t._v("è€Œå½“ "),e("code",[t._v("hint")]),t._v(" å°äº 8 æ—¶ï¼Œè¿™ç§é—®é¢˜"),e("strong",[t._v("ç›¸å¯¹")]),t._v("å°±ä¸ä¼šå‡¸æ˜¾çš„å¤ªæ˜æ˜¾ï¼Œå¦‚ä¸‹ï¼š")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("func makemap_small() *hmap {\n\th := new(hmap)\n\th.hash0 = fastrand()\n\treturn h\n}\n")])])]),e("h3",{attrs:{id:"å›¾ç¤º"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#å›¾ç¤º"}},[t._v("#")]),t._v(" å›¾ç¤º")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://i.imgur.com/Hoi01Qt.png",alt:"image"}})]),t._v(" "),e("h2",{attrs:{id:"è®¿é—®"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#è®¿é—®"}},[t._v("#")]),t._v(" è®¿é—®")]),t._v(" "),e("h3",{attrs:{id:"ç”¨æ³•-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ç”¨æ³•-2"}},[t._v("#")]),t._v(" ç”¨æ³•")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("v := m[i]\nv, ok := m[i]\n")])])]),e("h3",{attrs:{id:"å‡½æ•°åŸå‹-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#å‡½æ•°åŸå‹-2"}},[t._v("#")]),t._v(" å‡½æ•°åŸå‹")]),t._v(" "),e("p",[t._v("åœ¨å®ç° map å…ƒç´ è®¿é—®ä¸Šæœ‰å¥½å‡ ç§æ–¹æ³•ï¼Œä¸»è¦æ˜¯åŒ…å«é’ˆå¯¹ 32/64 ä½ã€string ç±»å‹çš„ç‰¹æ®Šå¤„ç†ï¼Œæ€»çš„å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("mapaccess1(t *maptype, h *hmap, key unsafe.Pointer) unsafe.Pointer\nmapaccess2(t *maptype, h *hmap, key unsafe.Pointer) (unsafe.Pointer, bool)\n\nmapaccessK(t *maptype, h *hmap, key unsafe.Pointer) (unsafe.Pointer, unsafe.Pointer)\n\nmapaccess1_fat(t *maptype, h *hmap, key, zero unsafe.Pointer) unsafe.Pointer\nmapaccess2_fat(t *maptype, h *hmap, key, zero unsafe.Pointer) (unsafe.Pointer, bool)\n\nmapaccess1_fast32(t *maptype, h *hmap, key uint32) unsafe.Pointer\nmapaccess2_fast32(t *maptype, h *hmap, key uint32) (unsafe.Pointer, bool)\nmapassign_fast32(t *maptype, h *hmap, key uint32) unsafe.Pointer\nmapassign_fast32ptr(t *maptype, h *hmap, key unsafe.Pointer) unsafe.Pointer\n\nmapaccess1_fast64(t *maptype, h *hmap, key uint64) unsafe.Pointer\n...\n\nmapaccess1_faststr(t *maptype, h *hmap, ky string) unsafe.Pointer\n...\n")])])]),e("ul",[e("li",[t._v("mapaccess1ï¼šè¿”å› "),e("code",[t._v("h[key]")]),t._v(" çš„æŒ‡é’ˆåœ°å€ï¼Œå¦‚æœé”®ä¸åœ¨ "),e("code",[t._v("map")]),t._v(" ä¸­ï¼Œå°†è¿”å›å¯¹åº”ç±»å‹çš„é›¶å€¼")]),t._v(" "),e("li",[t._v("mapaccess2ï¼šè¿”å› "),e("code",[t._v("h[key]")]),t._v(" çš„æŒ‡é’ˆåœ°å€ï¼Œå¦‚æœé”®ä¸åœ¨ "),e("code",[t._v("map")]),t._v(" ä¸­ï¼Œå°†è¿”å›é›¶å€¼å’Œå¸ƒå°”å€¼ç”¨äºåˆ¤æ–­")])]),t._v(" "),e("h3",{attrs:{id:"æºç -2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#æºç -2"}},[t._v("#")]),t._v(" æºç ")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('func mapaccess1(t *maptype, h *hmap, key unsafe.Pointer) unsafe.Pointer {\n\t...\n\tif h == nil || h.count == 0 {\n\t\treturn unsafe.Pointer(&zeroVal[0])\n\t}\n\tif h.flags&hashWriting != 0 {\n\t\tthrow("concurrent map read and map write")\n\t}\n\talg := t.key.alg\n\thash := alg.hash(key, uintptr(h.hash0))\n\tm := bucketMask(h.B)\n\tb := (*bmap)(add(h.buckets, (hash&m)*uintptr(t.bucketsize)))\n\tif c := h.oldbuckets; c != nil {\n\t\tif !h.sameSizeGrow() {\n\t\t\t// There used to be half as many buckets; mask down one more power of two.\n\t\t\tm >>= 1\n\t\t}\n\t\toldb := (*bmap)(add(c, (hash&m)*uintptr(t.bucketsize)))\n\t\tif !evacuated(oldb) {\n\t\t\tb = oldb\n\t\t}\n\t}\n\ttop := tophash(hash)\n\tfor ; b != nil; b = b.overflow(t) {\n\t\tfor i := uintptr(0); i < bucketCnt; i++ {\n\t\t\tif b.tophash[i] != top {\n\t\t\t\tcontinue\n\t\t\t}\n\t\t\tk := add(unsafe.Pointer(b), dataOffset+i*uintptr(t.keysize))\n\t\t\tif t.indirectkey {\n\t\t\t\tk = *((*unsafe.Pointer)(k))\n\t\t\t}\n\t\t\tif alg.equal(key, k) {\n\t\t\t\tv := add(unsafe.Pointer(b), dataOffset+bucketCnt*uintptr(t.keysize)+i*uintptr(t.valuesize))\n\t\t\t\tif t.indirectvalue {\n\t\t\t\t\tv = *((*unsafe.Pointer)(v))\n\t\t\t\t}\n\t\t\t\treturn v\n\t\t\t}\n\t\t}\n\t}\n\treturn unsafe.Pointer(&zeroVal[0])\n}\n')])])]),e("ul",[e("li",[t._v("åˆ¤æ–­ map æ˜¯å¦ä¸º nilï¼Œé•¿åº¦æ˜¯å¦ä¸º 0ã€‚è‹¥æ˜¯åˆ™è¿”å›é›¶å€¼")]),t._v(" "),e("li",[t._v("åˆ¤æ–­å½“å‰æ˜¯å¦å¹¶å‘è¯»å†™ mapï¼Œè‹¥æ˜¯åˆ™æŠ›å‡ºå¼‚å¸¸")]),t._v(" "),e("li",[t._v("æ ¹æ® key çš„ä¸åŒç±»å‹è°ƒç”¨ä¸åŒçš„ hash æ–¹æ³•è®¡ç®—å¾—å‡º hash å€¼")]),t._v(" "),e("li",[t._v("ç¡®å®š key åœ¨å“ªä¸€ä¸ª bucket ä¸­ï¼Œå¹¶å¾—åˆ°å…¶ä½ç½®")]),t._v(" "),e("li",[t._v("åˆ¤æ–­æ˜¯å¦æ­£åœ¨å‘ç”Ÿæ‰©å®¹ï¼ˆh.oldbuckets æ˜¯å¦ä¸º nilï¼‰ï¼Œè‹¥æ­£åœ¨æ‰©å®¹ï¼Œåˆ™åˆ°è€çš„ buckets ä¸­æŸ¥æ‰¾ï¼ˆå› ä¸º buckets ä¸­å¯èƒ½è¿˜æ²¡æœ‰å€¼ï¼Œæ¬è¿æœªå®Œæˆï¼‰ï¼Œè‹¥è¯¥ bucket å·²ç»æ¬è¿å®Œæ¯•ã€‚åˆ™åˆ° buckets ä¸­ç»§ç»­æŸ¥æ‰¾")]),t._v(" "),e("li",[t._v("è®¡ç®— hash çš„ tophash å€¼ï¼ˆé«˜å…«ä½ï¼‰")]),t._v(" "),e("li",[t._v("æ ¹æ®è®¡ç®—å‡ºæ¥çš„ tophashï¼Œä¾æ¬¡å¾ªç¯å¯¹æ¯” buckets çš„ tophash å€¼ï¼ˆå¿«é€Ÿè¯•é”™ï¼‰")]),t._v(" "),e("li",[t._v("å¦‚æœ tophash åŒ¹é…æˆåŠŸï¼Œåˆ™è®¡ç®— key çš„æ‰€åœ¨ä½ç½®ï¼Œæ­£å¼å®Œæ•´çš„å¯¹æ¯”ä¸¤ä¸ª key æ˜¯å¦ä¸€è‡´")]),t._v(" "),e("li",[t._v("è‹¥æŸ¥æ‰¾æˆåŠŸå¹¶è¿”å›ï¼Œè‹¥ä¸å­˜åœ¨ï¼Œåˆ™è¿”å›é›¶å€¼")])]),t._v(" "),e("p",[t._v("åœ¨ä¸Šè¿°æ­¥éª¤ä¸‰ä¸­ï¼Œæåˆ°äº†æ ¹æ®ä¸åŒçš„ç±»å‹è®¡ç®—å‡º hash å€¼ï¼Œå¦å¤–ä¼šè®¡ç®—å‡º hash å€¼çš„é«˜å…«ä½å’Œä½å…«ä½ã€‚ä½å…«ä½ä¼šä½œä¸º bucket indexï¼Œä½œç”¨æ˜¯ç”¨äºæ‰¾åˆ° key æ‰€åœ¨çš„ bucketã€‚è€Œé«˜å…«ä½ä¼šå­˜å‚¨åœ¨ bmap tophash ä¸­")]),t._v(" "),e("p",[t._v("å…¶ä¸»è¦ä½œç”¨æ˜¯åœ¨ä¸Šè¿°æ­¥éª¤ä¸ƒä¸­è¿›è¡Œè¿­ä»£å¿«é€Ÿå®šä½ã€‚è¿™æ ·å­å¯ä»¥æé«˜æ€§èƒ½ï¼Œè€Œä¸æ˜¯ä¸€å¼€å§‹å°±ç›´æ¥ç”¨ key è¿›è¡Œä¸€è‡´æ€§å¯¹æ¯”")]),t._v(" "),e("h3",{attrs:{id:"å›¾ç¤º-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#å›¾ç¤º-2"}},[t._v("#")]),t._v(" å›¾ç¤º")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://i.imgur.com/Y4rmolX.png",alt:"image"}})]),t._v(" "),e("h2",{attrs:{id:"æ€»ç»“"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#æ€»ç»“"}},[t._v("#")]),t._v(" æ€»ç»“")]),t._v(" "),e("p",[t._v("åœ¨æœ¬ç« èŠ‚ï¼Œæˆ‘ä»¬ä»‹ç»äº† map ç±»å‹çš„ä»¥ä¸‹çŸ¥è¯†ç‚¹ï¼š")]),t._v(" "),e("ul",[e("li",[t._v("map çš„åŸºç¡€æ•°æ®ç»“æ„")]),t._v(" "),e("li",[t._v("åˆå§‹åŒ– map")]),t._v(" "),e("li",[t._v("è®¿é—® map")])]),t._v(" "),e("p",[t._v("ä»é˜…è¯»æºç ä¸­ï¼Œå¾—çŸ¥ Go æœ¬èº«"),e("strong",[t._v("å¯¹äºä¸€äº›ä¸åŒå¤§å°ã€ä¸åŒç±»å‹çš„å±æ€§ï¼ŒåŒ…æ‹¬å“ˆå¸Œæ–¹æ³•éƒ½æœ‰ç¼–å†™ç‰¹å®šæ–¹æ³•")]),t._v("å»è¿è¡Œã€‚æ€»çš„æ¥è¯´ï¼Œè¿™å—çš„è®¾è®¡éšå«è¾ƒå¤šçš„æ€è·¯ï¼Œæœ‰ä¸å°‘ç‚¹å€¼å¾—ç»†ç»†å“å° ğŸ˜ƒ")]),t._v(" "),e("p",[t._v("æ³¨ï¼šæœ¬æ–‡åŸºäº Go 1.11.5")])])}),[],!1,null,null,null);a.default=v.exports}}]);