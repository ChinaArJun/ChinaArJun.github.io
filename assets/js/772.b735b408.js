(window.webpackJsonp=window.webpackJsonp||[]).push([[772],{1373:function(s,t,a){"use strict";a.r(t);var e=a(44),l=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"mysql高级知识-第4章"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql高级知识-第4章"}},[s._v("#")]),s._v(" MySQL高级知识-第4章")]),s._v(" "),a("p",[s._v("[toc]")]),s._v(" "),a("h2",{attrs:{id:"慢查询"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#慢查询"}},[s._v("#")]),s._v(" 慢查询")]),s._v(" "),a("h3",{attrs:{id:"慢查询设置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#慢查询设置"}},[s._v("#")]),s._v(" 慢查询设置")]),s._v(" "),a("p",[s._v("1.默认没有启动慢查询日志，需要手动设置")]),s._v(" "),a("p",[s._v("如果不是调优需要的话，不建议开启该参数，")]),s._v(" "),a("p",[s._v("因为开启慢查询日志会带来一定的性能影响，慢查询日志支持日志记录写入文件")]),s._v(" "),a("p",[s._v("可以执行下面命令进行查看是否开启慢查询：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("SHOW VARIABLES LIKE '%slow_query_log%';\n")])])]),a("p",[s._v("2.开启方式")]),s._v(" "),a("p",[s._v("可以使用下面命令进行开启")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("set slow_query_log=1\n")])])]),a("p",[s._v("或者写入mysql配置文件中\n"),a("br")]),s._v(" "),a("h3",{attrs:{id:"慢查询条件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#慢查询条件"}},[s._v("#")]),s._v(" 慢查询条件")]),s._v(" "),a("p",[s._v("1.什么样的sql才会被写入慢查询日志呢？")]),s._v(" "),a("p",[s._v("查看当前多少秒算慢？")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("SHOW VARIABLES LIKE 'long_query_time%';\n")])])]),a("p",[s._v("设置慢的阙值时间")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v(" set long_query_time = 3\n")])])]),a("p",[s._v("2.为什么设置后看不出变化？")]),s._v(" "),a("p",[s._v("需要重新连接或新开一个会话才能看到修改值。")]),s._v(" "),a("h3",{attrs:{id:"慢查询检测"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#慢查询检测"}},[s._v("#")]),s._v(" 慢查询检测")]),s._v(" "),a("p",[s._v("当MySQL繁忙的时候运行"),a("strong",[s._v("show processlist")]),s._v("，会发现有很多行输出，每行输出对应一个MySQL连接。")]),s._v(" "),a("p",[s._v("在运营网站的过程中，可能会遇到网站突然变慢的问题，一般情况下和 MySQL 慢有关系，可以通过开启慢查询，找到影响效率的 SQL ，然后采取相应的措施。")]),s._v(" "),a("p",[s._v("MySQL有一个功能就是可以log下来运行的比较慢的sql语句，默认是没有这个log的，为了开启这个功能，要修改 my.cnf或者在MySQL启动的时候加入一些参数。")]),s._v(" "),a("p",[s._v("如果在my.cnf里面修改，需增加如下几行")]),s._v(" "),a("blockquote",[a("p",[s._v("long_query_time = 1")])]),s._v(" "),a("blockquote",[a("p",[s._v("log-slow-queries =")])]),s._v(" "),a("blockquote",[a("p",[s._v("log-queries-not-using-indexes")])]),s._v(" "),a("blockquote",[a("p",[s._v("long_query_time 是指执行超过多久的sql会被log下来，这里是1秒。")])]),s._v(" "),a("blockquote",[a("p",[s._v("log-slow-queries 设置把日志写在那里，可以为空，系统会给一个缺省的文件\nlog-queries-not-using-indexes 就是纪录没使用索引的sql")])]),s._v(" "),a("h3",{attrs:{id:"慢查询路径"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#慢查询路径"}},[s._v("#")]),s._v(" 慢查询路径")]),s._v(" "),a("p",[s._v("可以执行下面的命令查看慢查询日志路径：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("mysql> show variables like '%slow%';\n+---------------------+---------------------------------+\n| Variable_name       | Value                           |\n+---------------------+---------------------------------+\n| log_slow_queries    | OFF                             |\n| slow_launch_time    | 2                               |\n| slow_query_log      | OFF                             |\n| slow_query_log_file | /var/run/mysqld/mysqld-slow.log |\n+---------------------+---------------------------------+\n4 rows in set (0.00 sec)\n")])])]),a("h3",{attrs:{id:"慢查询分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#慢查询分析"}},[s._v("#")]),s._v(" 慢查询分析")]),s._v(" "),a("p",[s._v("阅读慢速查询日志最好是通过 "),a("strong",[a("code",[s._v("mysqldumpslow")])]),s._v(" 命令进行")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("mysqldumpslow –help以下，主要用的是\n-s ORDER what to sort by (t, at, l, al, r, ar etc), ‘at’ is default\n-t NUM just show the top n queries\n-g PATTERN grep: only consider stmts that include this string\n\n-s，是order的顺序，说明写的不够详细，俺用下来，包括看了代码，主要有\nc,t,l,r和ac,at,al,ar，分别是按照query次数，时间，lock的时间和返回的记录数来排序，前面加了a的时倒叙\n-t，是top n的意思，即为返回前面多少条的数据\n-g，后边可以写一个正则匹配模式，大小写不敏感的\n")])])]),a("p",[s._v("例子：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("mysqldumpslow -s c -t 20 host-slow.log\nmysqldumpslow -s r -t 20 host-slow.log\n")])])]),a("p",[s._v("上述命令可以看出访问次数最多的20个sql语句和返回记录集最多的20个sql。")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("mysqldumpslow -t 10 -s t -g “left join” host-slow.log\n")])])]),a("p",[s._v("这个是按照时间返回前10条里面含有左连接的sql语句。")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("Time: 060908 22:17:43\n Query_time: 12 Lock_time: 0 Rows_sent: 86345 Rows_examined: 580963\n \nQ:这个是慢查的日志,都是些什么意思?\nA:查询用了12妙，返回86345行，一共查了580963行\n")])])])])}),[],!1,null,null,null);t.default=l.exports}}]);