(window.webpackJsonp=window.webpackJsonp||[]).push([[314],{892:function(e,t,n){"use strict";n.r(t);var a=n(44),r=Object(a.a)({},(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h1",{attrs:{id:"_4-9-grpc-deadlines"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-9-grpc-deadlines"}},[e._v("#")]),e._v(" 4.9 gRPC Deadlines")]),e._v(" "),n("h2",{attrs:{id:"å‰è¨€"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#å‰è¨€"}},[e._v("#")]),e._v(" å‰è¨€")]),e._v(" "),n("p",[e._v("åœ¨å‰é¢çš„ç« èŠ‚ä¸­ï¼Œå·²ç»ä»‹ç»äº† gRPC çš„åŸºæœ¬ç”¨æ³•ã€‚é‚£ä½ æƒ³æƒ³ï¼Œè®©å®ƒè¿™ä¹ˆè£¸è·‘çœŸçš„æ²¡é—®é¢˜å—ï¼Ÿ")]),e._v(" "),n("p",[e._v("é‚£ä¹ˆï¼Œè‚¯å®šæ˜¯æœ‰é—®é¢˜äº†ã€‚ä»Šå¤©å°†ä»‹ç» gRPC Deadlines çš„ç”¨æ³•ï¼Œè¿™ä¸€ä¸ªå¿…å¤‡æŠ€å·§ã€‚å†…å®¹ä¹Ÿæ¯”è¾ƒç®€å•")]),e._v(" "),n("h2",{attrs:{id:"deadlines"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#deadlines"}},[e._v("#")]),e._v(" Deadlines")]),e._v(" "),n("p",[e._v("Deadlines æ„æŒ‡æˆªæ­¢æ—¶é—´ï¼Œåœ¨ gRPC ä¸­å¼ºè°ƒ TL;DRï¼ˆToo long, Don't readï¼‰å¹¶å»ºè®®"),n("strong",[e._v("å§‹ç»ˆè®¾å®šæˆªæ­¢æ—¥æœŸ")]),e._v("ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ")]),e._v(" "),n("h3",{attrs:{id:"ä¸ºä»€ä¹ˆè¦è®¾ç½®"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ä¸ºä»€ä¹ˆè¦è®¾ç½®"}},[e._v("#")]),e._v(" ä¸ºä»€ä¹ˆè¦è®¾ç½®")]),e._v(" "),n("p",[e._v("å½“æœªè®¾ç½® Deadlines æ—¶ï¼Œå°†é‡‡ç”¨é»˜è®¤çš„ DEADLINE_EXCEEDEDï¼ˆè¿™ä¸ªæ—¶é—´éå¸¸å¤§ï¼‰")]),e._v(" "),n("p",[e._v("å¦‚æœäº§ç”Ÿäº†é˜»å¡ç­‰å¾…ï¼Œå°±ä¼šé€ æˆå¤§é‡æ­£åœ¨è¿›è¡Œçš„è¯·æ±‚éƒ½ä¼šè¢«ä¿ç•™ï¼Œå¹¶ä¸”æ‰€æœ‰è¯·æ±‚éƒ½æœ‰å¯èƒ½è¾¾åˆ°æœ€å¤§è¶…æ—¶")]),e._v(" "),n("p",[e._v("è¿™ä¼šä½¿æœåŠ¡é¢ä¸´èµ„æºè€—å°½çš„é£é™©ï¼Œä¾‹å¦‚å†…å­˜ï¼Œè¿™ä¼šå¢åŠ æœåŠ¡çš„å»¶è¿Ÿï¼Œæˆ–è€…åœ¨æœ€åçš„æƒ…å†µä¸‹å¯èƒ½å¯¼è‡´æ•´ä¸ªè¿›ç¨‹å´©æºƒ")]),e._v(" "),n("h2",{attrs:{id:"grpc"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#grpc"}},[e._v("#")]),e._v(" gRPC")]),e._v(" "),n("h3",{attrs:{id:"client"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#client"}},[e._v("#")]),e._v(" Client")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('func main() {\n    ...\n\tctx, cancel := context.WithDeadline(context.Background(), time.Now().Add(time.Duration(5 * time.Second)))\n\tdefer cancel()\n\n\tclient := pb.NewSearchServiceClient(conn)\n\tresp, err := client.Search(ctx, &pb.SearchRequest{\n\t\tRequest: "gRPC",\n\t})\n\tif err != nil {\n\t\tstatusErr, ok := status.FromError(err)\n\t\tif ok {\n\t\t\tif statusErr.Code() == codes.DeadlineExceeded {\n\t\t\t\tlog.Fatalln("client.Search err: deadline")\n\t\t\t}\n\t\t}\n\n\t\tlog.Fatalf("client.Search err: %v", err)\n\t}\n\n\tlog.Printf("resp: %s", resp.GetResponse())\n}\n')])])]),n("ul",[n("li",[e._v("context.WithDeadlineï¼šä¼šè¿”å›æœ€ç»ˆä¸Šä¸‹æ–‡æˆªæ­¢æ—¶é—´ã€‚ç¬¬ä¸€ä¸ªå½¢å‚ä¸ºçˆ¶ä¸Šä¸‹æ–‡ï¼Œç¬¬äºŒä¸ªå½¢å‚ä¸ºè°ƒæ•´çš„æˆªæ­¢æ—¶é—´ã€‚è‹¥çˆ¶çº§æ—¶é—´æ—©äºå­çº§æ—¶é—´ï¼Œåˆ™ä»¥çˆ¶çº§æ—¶é—´ä¸ºå‡†ï¼Œå¦åˆ™ä»¥å­çº§æ—¶é—´ä¸ºæœ€ç»ˆæˆªæ­¢æ—¶é—´")])]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("func WithDeadline(parent Context, d time.Time) (Context, CancelFunc) {\n\tif cur, ok := parent.Deadline(); ok && cur.Before(d) {\n\t\t// The current deadline is already sooner than the new one.\n\t\treturn WithCancel(parent)\n\t}\n\tc := &timerCtx{\n\t\tcancelCtx: newCancelCtx(parent),\n\t\tdeadline:  d,\n\t}\n\tpropagateCancel(parent, c)\n\tdur := time.Until(d)\n\tif dur <= 0 {\n\t\tc.cancel(true, DeadlineExceeded) // deadline has already passed\n\t\treturn c, func() { c.cancel(true, Canceled) }\n\t}\n\tc.mu.Lock()\n\tdefer c.mu.Unlock()\n\tif c.err == nil {\n\t\tc.timer = time.AfterFunc(dur, func() {\n\t\t\tc.cancel(true, DeadlineExceeded)\n\t\t})\n\t}\n\treturn c, func() { c.cancel(true, Canceled) }\n}\n")])])]),n("ul",[n("li",[e._v("context.WithTimeoutï¼šå¾ˆå¸¸è§çš„å¦å¤–ä¸€ä¸ªæ–¹æ³•ï¼Œæ˜¯ä¾¿æ·æ“ä½œã€‚å®é™…ä¸Šæ˜¯å¯¹äº WithDeadline çš„å°è£…")])]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc) {\n\treturn WithDeadline(parent, time.Now().Add(timeout))\n}\n")])])]),n("ul",[n("li",[e._v("status.FromErrorï¼šè¿”å› GRPCStatus çš„å…·ä½“é”™è¯¯ç ï¼Œè‹¥ä¸ºéæ³•ï¼Œåˆ™ç›´æ¥è¿”å› "),n("code",[e._v("codes.Unknown")])])]),e._v(" "),n("h3",{attrs:{id:"server"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#server"}},[e._v("#")]),e._v(" Server")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('type SearchService struct{}\n\nfunc (s *SearchService) Search(ctx context.Context, r *pb.SearchRequest) (*pb.SearchResponse, error) {\n\tfor i := 0; i < 5; i++  {\n\t\tif ctx.Err() == context.Canceled {\n\t\t\treturn nil, status.Errorf(codes.Canceled, "SearchService.Search canceled")\n\t\t}\n\n\t\ttime.Sleep(1 * time.Second)\n\t}\n\n\treturn &pb.SearchResponse{Response: r.GetRequest() + " Server"}, nil\n}\n\nfunc main() {\n\t...\n}\n')])])]),n("p",[e._v("è€Œåœ¨ Server ç«¯ï¼Œç”±äº Client å·²ç»è®¾ç½®äº†æˆªæ­¢æ—¶é—´ã€‚Server åŠ¿å¿…è¦å»æ£€æµ‹å®ƒ")]),e._v(" "),n("p",[e._v("å¦åˆ™å¦‚æœ Client å·²ç»ç»“æŸæ‰äº†ï¼ŒServer è¿˜å‚»å‚»çš„åœ¨é‚£æ‰§è¡Œï¼Œè¿™å¯¹èµ„æºæ˜¯ä¸€ç§æå¤§çš„æµªè´¹")]),e._v(" "),n("p",[e._v("å› æ­¤åœ¨è¿™é‡Œéœ€è¦ç”¨ "),n("code",[e._v("ctx.Err() == context.Canceled")]),e._v(" è¿›è¡Œåˆ¤æ–­ï¼Œä¸ºäº†æ¨¡æ‹Ÿåœºæ™¯æˆ‘ä»¬åŠ äº†å¾ªç¯å’Œç¡çœ  ğŸ¤”")]),e._v(" "),n("h3",{attrs:{id:"éªŒè¯"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#éªŒè¯"}},[e._v("#")]),e._v(" éªŒè¯")]),e._v(" "),n("p",[e._v("é‡æ–°å¯åŠ¨ server.go å’Œ client.goï¼Œå¾—åˆ°ç»“æœï¼š")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("$ go run client.go\n2018/10/06 17:45:55 client.Search err: deadline\nexit status 1\n")])])]),n("h2",{attrs:{id:"æ€»ç»“"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#æ€»ç»“"}},[e._v("#")]),e._v(" æ€»ç»“")]),e._v(" "),n("p",[e._v("æœ¬ç« èŠ‚æ¯”è¾ƒç®€å•ï¼Œä½ éœ€è¦çŸ¥é“ä»¥ä¸‹çŸ¥è¯†ç‚¹ï¼š")]),e._v(" "),n("ul",[n("li",[e._v("æ€ä¹ˆè®¾ç½® Deadlines")]),e._v(" "),n("li",[e._v("ä¸ºä»€ä¹ˆè¦è®¾ç½® Deadlines")])]),e._v(" "),n("p",[e._v("ä½ è¦æ¸…æ¥šåœ°æ˜ç™½åˆ°ï¼ŒgRPC Deadlines æ˜¯å¾ˆé‡è¦çš„ï¼Œå¦åˆ™è¿™å°å°çš„åŠŸèƒ½ç‚¹å°±ä¼šè¦äº†ä½ ç”Ÿäº§çš„å‘½ ğŸ¤«")]),e._v(" "),n("h2",{attrs:{id:"å‚è€ƒ"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#å‚è€ƒ"}},[e._v("#")]),e._v(" å‚è€ƒ")]),e._v(" "),n("h3",{attrs:{id:"æœ¬ç³»åˆ—ç¤ºä¾‹ä»£ç "}},[n("a",{staticClass:"header-anchor",attrs:{href:"#æœ¬ç³»åˆ—ç¤ºä¾‹ä»£ç "}},[e._v("#")]),e._v(" æœ¬ç³»åˆ—ç¤ºä¾‹ä»£ç ")]),e._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://github.com/EDDYCJY/go-grpc-example",target:"_blank",rel:"noopener noreferrer"}},[e._v("go-grpc-example"),n("OutboundLink")],1)])]),e._v(" "),n("h3",{attrs:{id:"èµ„æ–™"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#èµ„æ–™"}},[e._v("#")]),e._v(" èµ„æ–™")]),e._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://grpc.io/blog/deadlines",target:"_blank",rel:"noopener noreferrer"}},[e._v("gRPC and Deadlines\n"),n("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=r.exports}}]);