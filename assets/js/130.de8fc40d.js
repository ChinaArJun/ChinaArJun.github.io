(window.webpackJsonp=window.webpackJsonp||[]).push([[130],{682:function(a,t,s){"use strict";s.r(t);var n=s(44),e=Object(n.a)({},(function(){var a=this,t=a.$createElement,s=a._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"使用-openvpn-与集群内部服务通信"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用-openvpn-与集群内部服务通信"}},[a._v("#")]),a._v(" 使用 openvpn 与集群内部服务通信")]),a._v(" "),s("p",[a._v("当我们访问集群内部服务，如数据库，缓存，"),s("code",[a._v("traefik Dashboard")]),a._v("，"),s("code",[a._v("gitlab")]),a._v(" 时，如果直接暴露在公网中，则会造成很大安全隐患，而使用 "),s("code",[a._v("Basic Auth")]),a._v(" 等也不能完全避开问题。此时在开发环境使用 "),s("code",[a._v("Virtual Private Network")]),a._v(" 连接集群是一个不错的选择")]),a._v(" "),s("blockquote",[s("p",[a._v("Q: "),s("a",{attrs:{href:"https://github.com/ChinaArJun/Daily-Question/issues/125",target:"_blank",rel:"noopener noreferrer"}},[a._v("在集群中如何保证私有服务的安全性"),s("OutboundLink")],1)])]),a._v(" "),s("ul",[s("li",[a._v("原文链接: "),s("a",{attrs:{href:"https://github.com/ChinaArJun/op-note/blob/master/openvpn.md",target:"_blank",rel:"noopener noreferrer"}},[a._v("使用 openvpn 与集群内部服务通信"),s("OutboundLink")],1)]),a._v(" "),s("li",[a._v("系列文章: "),s("a",{attrs:{href:"https://github.com/ChinaArJun/op-note",target:"_blank",rel:"noopener noreferrer"}},[a._v("当我有台服务器时我做了什么"),s("OutboundLink")],1)])]),a._v(" "),s("h2",{attrs:{id:"部署-openvpn"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#部署-openvpn"}},[a._v("#")]),a._v(" 部署 openvpn")]),a._v(" "),s("p",[a._v("准备 "),s("code",[a._v("docker-compose.yaml")]),a._v(" 如下，我们同样把它置于网络 "),s("code",[a._v("traefik-default")]),a._v(" 下。"),s("code",[a._v("traefik-default")]),a._v(" 是 "),s("code",[a._v("traefik")]),a._v(" 用以服务发现的所有应用的入口网关，详情可参考上一节 "),s("a",{attrs:{href:"https://github.com/ChinaArJun/op-note/blob/master/traefik.md",target:"_blank",rel:"noopener noreferrer"}},[a._v("traefik 简易入门"),s("OutboundLink")],1)]),a._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'3'")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("services")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("openvpn")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("cap_add")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" NET_ADMIN\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" kylemanna/openvpn\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("container_name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" openvpn\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"1194:1194/udp"')]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("restart")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" always\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" ./openvpn"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("data/conf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("/etc/openvpn\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("networks")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("default")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("external")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" traefik_default\n")])])]),s("p",[a._v("初始化配置文件，注意替换掉你真实的公网IP，并且需要在 "),s("code",[a._v("iptables")]),a._v(" 或者阿里云安全组中把 1194 端口给暴露出来")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("$ docker run -v "),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("pwd")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("/openvpn-data/conf:/etc/openvpn --log-driver"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("none --rm kylemanna/openvpn ovpn_genconfig -u udp://"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("IP"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\n")])])]),s("p",[a._v("初始化证书，此时需要交互式确认密码")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("$ docker run -v "),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("pwd")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("/openvpn-data/conf:/etc/openvpn --log-driver"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("none --rm -it kylemanna/openvpn ovpn_initpki\n")])])]),s("p",[a._v("生成客户端证书")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("$ docker run -v "),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("pwd")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("/openvpn-data/conf:/etc/openvpn --log-driver"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("none --rm -it kylemanna/openvpn easyrsa build-client-full shanyue nopass\n")])])]),s("p",[a._v("生成客户端配置文件 "),s("code",[a._v("shanyue.ovpn")]),a._v("，成功生成后需要把该文件传到本地。")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("$ docker run -v "),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("pwd")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("/openvpn-data/conf:/etc/openvpn --log-driver"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("none --rm kylemanna/openvpn ovpn_getclient shanyue "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" shanyue.ovpn\n")])])]),s("h2",{attrs:{id:"客户端连接"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#客户端连接"}},[a._v("#")]),a._v(" 客户端连接")]),a._v(" "),s("p",[a._v("使用 "),s("code",[a._v("rsync")]),a._v(" 把生成的配置文件传到本地环境")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("rsync")]),a._v(" -avhzP dev:/path/openvpn/shanyue.ovpn "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(".")]),a._v("\n")])])]),s("p",[a._v("使用 "),s("a",{attrs:{href:"https://tunnelblick.net/",target:"_blank",rel:"noopener noreferrer"}},[a._v("tunnelblick"),s("OutboundLink")],1),a._v(" 打开配置文件，点击连接 vpn，连接成功")]),a._v(" "),s("h2",{attrs:{id:"访问内部集群"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#访问内部集群"}},[a._v("#")]),a._v(" 访问内部集群")]),a._v(" "),s("p",[a._v("在 "),s("a",{attrs:{href:"https://github.com/ChinaArJun/op-note/blob/master/traefik.md",target:"_blank",rel:"noopener noreferrer"}},[a._v("traefik 简易入门"),s("OutboundLink")],1),a._v(" 中，我们在集群中配置了 "),s("code",[a._v("whoami.docker.localhost")]),a._v(" 用以访问 "),s("code",[a._v("whoami")]),a._v(" 服务。")]),a._v(" "),s("p",[s("strong",[a._v("此时我们通过在本地环境连接 VPN，查看在本地是否可以访问集群服务")])]),a._v(" "),s("p",[a._v("查看 "),s("code",[a._v("traefik")]),a._v(" 的网络 IP")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("$ docker network inspect traefik-default\n\n        "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"IPAM"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"Driver"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"default"')]),a._v(",\n            "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"Options"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(":")]),a._v(" null,\n            "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"Config"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n                    "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"Subnet"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"172.18.0.0/16"')]),a._v(",\n                    "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"Gateway"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"172.18.0.1"')]),a._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v(",\n")])])]),s("p",[a._v("找到 IP 后，我们通过 "),s("code",[a._v("curl")]),a._v(" 查看服务是否可以正常访问")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("$ "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" -H Host:whoami.docker.localhost http://172.18.0.1\nHostname: eb290c85a325\nIP: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("127.0")]),a._v(".0.1\nIP: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("172.18")]),a._v(".0.2\nRemoteAddr: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("172.18")]),a._v(".0.3:34012\nGET / HTTP/1.1\nHost: whoami.docker.localhost\nUser-Agent: curl/7.54.0\nAccept: */*\nAccept-Encoding: "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("gzip")]),a._v("\nX-Forwarded-For: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("172.18")]),a._v(".0.1\nX-Forwarded-Host: whoami.docker.localhost\nX-Forwarded-Port: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("80")]),a._v("\nX-Forwarded-Proto: http\nX-Forwarded-Server: 11e1f03c87ef\nX-Real-Ip: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("172.18")]),a._v(".0.1\n")])])]),s("p",[a._v("此时在本地环境可以通过 "),s("code",[a._v("openvpn")]),a._v(" 来连接内部集群")]),a._v(" "),s("h2",{attrs:{id:"下一步"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#下一步"}},[a._v("#")]),a._v(" 下一步")]),a._v(" "),s("p",[a._v("此时我们访问 "),s("code",[a._v("whoami.docker.localhost")]),a._v(" 仍然是通过指定 Host 的方式")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("$ "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" -H Host:whoami.docker.localhost http://172.18.0.1\n")])])]),s("p",[a._v("那我们为什么不能直接 "),s("code",[a._v("curl whoami.docker.localhost")]),a._v(" 来访问服务呢？")]),a._v(" "),s("p",[a._v("因为 DNS 无法解析到正确的地址")]),a._v(" "),s("p",[a._v("那我们使用 IP 地址又不是很方便，这时应该怎么办？")]),a._v(" "),s("p",[s("strong",[a._v("搭建一个本地的DNS服务")]),a._v("，下一章将介绍如何搭建一个本地的DNS服务。")])])}),[],!1,null,null,null);t.default=e.exports}}]);